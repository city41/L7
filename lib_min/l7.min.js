(function(){this.L7=this.L7||{};this.L7.global=this;Object.defineProperty(this.L7,"useWebGL",{get:function(){return this._useWebGL},set:function(a){if(this.hasOwnProperty("_useWebGL"))throw Error("You can only set useWebGL once");this._useWebGL=a}})})();
(function(){L7.AnimationFactory=function(a,b){this._owner=a;this._board=b;this._buildStack=[];this._targetStack=[]};L7.AnimationFactory.prototype={_getBoard:function(){return this._board||this._owner.board},_determineTargets:function(a){return a.targets?a.targets:this._owner.getAnimationTargets(a.filter)},_addParentAnimation:function(a,b,c,d){c=new c(d);b&&this._targetStack.push(this._determineTargets(b));this._buildStack.push(c);a(this);this._buildStack.pop();b&&this._targetStack.pop();0===this._buildStack.length?
this._getBoard().addDaemon(c):this._buildStack.last.children.add(c);return c},_addAnimation:function(a,b){a.targets||(a.targets="undefined"!==typeof a.filter?this._owner.getAnimationTargets(a.filter):0<this._targetStack.length?this._targetStack.last:this._owner.getAnimationTargets());var c=new b(a);0===this._buildStack.length?this._getBoard().addDaemon(c):this._buildStack.last.children.add(c);return c},disco:function(a){return this._addAnimation(a,L7.Disco)},shimmer:function(a){return this._addAnimation(a,
L7.Shimmer)},plasma:function(a){return this._addAnimation(a,L7.Plasma)},setProperty:function(a){a.duration=0;a.from=a.to=a.value;return this.tween(a)},tween:function(a){return this._addAnimation(a,L7.Tween)},sequence:function(a,b){return this.repeat(1,a,b)},together:function(a,b){var c,d;_.isFunction(a)?d=a:(c=a,d=b);return this._addParentAnimation(d,c,L7.Together)},repeat:function(a,b,c){var d;_.isFunction(b)||(d=b,b=c);return this._addParentAnimation(b,d,L7.Repeat,a)},wait:function(a){return this.waitBetween(a,
a)},waitBetween:function(a,b){return this._addAnimation({min:a,max:b},L7.Wait)},invoke:function(a){return this._addAnimation({func:a},L7.Invoke)},die:function(){var a=this._buildStack.first;if(a){var b=this;return this.invoke(function(){b._getBoard().removeDaemon(a)})}}}})();
(function(){var a=[255,255,255,0.9],b=[255,255,255,0.6];L7.Disco=function(a){_.extend(this,a);this.reset()};L7.Disco.prototype={reset:function(){this.done=!1;this.even=!0;this._discoCount=this._elapsed=0},update:function(a){this.done||(this._elapsed+=a,this._elapsed>=this.rate&&(this.even=!this.even,this._doDisco(this.even,this.targets,this.width),this._elapsed-=this.rate,++this._discoCount),this.done=2<=this._discoCount)},_doDisco:function(c,d,e){for(var f=0;f<d.length;++f){var g=f%e;0===g&&(c=!c);
d[f].overlayColor=c?0===(g&1)?a:b:1===(g&1)?a:b}}}})();Math.linearTween=function(a,b,c,d){return c*a/d+b};Math.easeInQuad=function(a,b,c,d){return c*(a/=d)*a+b};Math.easeOutQuad=function(a,b,c,d){return-c*(a/=d)*(a-2)+b};Math.easeInOutQuad=function(a,b,c,d){return 1>(a/=d/2)?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b};Math.easeInCubic=function(a,b,c,d){return c*(a/=d)*a*a+b};Math.easeOutCubic=function(a,b,c,d){return c*((a=a/d-1)*a*a+1)+b};
Math.easeInOutCubic=function(a,b,c,d){return 1>(a/=d/2)?c/2*a*a*a+b:c/2*((a-=2)*a*a+2)+b};Math.easeInQuart=function(a,b,c,d){return c*(a/=d)*a*a*a+b};Math.easeOutQuart=function(a,b,c,d){return-c*((a=a/d-1)*a*a*a-1)+b};Math.easeInOutQuart=function(a,b,c,d){return 1>(a/=d/2)?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b};Math.easeInQuint=function(a,b,c,d){return c*(a/=d)*a*a*a*a+b};Math.easeOutQuint=function(a,b,c,d){return c*((a=a/d-1)*a*a*a*a+1)+b};
Math.easeInOutQuint=function(a,b,c,d){return 1>(a/=d/2)?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b};Math.easeInSine=function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b};Math.easeOutSine=function(a,b,c,d){return c*Math.sin(a/d*(Math.PI/2))+b};Math.easeInOutSine=function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b};Math.easeInExpo=function(a,b,c,d){return 0==a?b:c*Math.pow(2,10*(a/d-1))+b};Math.easeOutExpo=function(a,b,c,d){return a==d?b+c:c*(-Math.pow(2,-10*a/d)+1)+b};
Math.easeInOutExpo=function(a,b,c,d){return 0==a?b:a==d?b+c:1>(a/=d/2)?c/2*Math.pow(2,10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b};Math.easeInCirc=function(a,b,c,d){return-c*(Math.sqrt(1-(a/=d)*a)-1)+b};Math.easeOutCirc=function(a,b,c,d){return c*Math.sqrt(1-(a=a/d-1)*a)+b};Math.easeInOutCirc=function(a,b,c,d){return 1>(a/=d/2)?-c/2*(Math.sqrt(1-a*a)-1)+b:c/2*(Math.sqrt(1-(a-=2)*a)+1)+b};
Math.easeInElastic=function(a,b,c,d,e,f){if(0==a)return b;if(1==(a/=d))return b+c;f||(f=0.3*d);e<Math.abs(c)?(e=c,c=f/4):c=f/(2*Math.PI)*Math.asin(c/e);return-(e*Math.pow(2,10*(a-=1))*Math.sin((a*d-c)*2*Math.PI/f))+b};Math.easeOutElastic=function(a,b,c,d,e,f){if(0==a)return b;if(1==(a/=d))return b+c;f||(f=0.3*d);if(e<Math.abs(c))var e=c,g=f/4;else g=f/(2*Math.PI)*Math.asin(c/e);return e*Math.pow(2,-10*a)*Math.sin((a*d-g)*2*Math.PI/f)+c+b};
Math.easeInOutElastic=function(a,b,c,d,e,f){if(0==a)return b;if(2==(a/=d/2))return b+c;f||(f=d*0.3*1.5);if(e<Math.abs(c))var e=c,g=f/4;else g=f/(2*Math.PI)*Math.asin(c/e);return 1>a?-0.5*e*Math.pow(2,10*(a-=1))*Math.sin((a*d-g)*2*Math.PI/f)+b:0.5*e*Math.pow(2,-10*(a-=1))*Math.sin((a*d-g)*2*Math.PI/f)+c+b};Math.easeInBack=function(a,b,c,d,e){void 0==e&&(e=1.70158);return c*(a/=d)*a*((e+1)*a-e)+b};Math.easeOutBack=function(a,b,c,d,e){void 0==e&&(e=1.70158);return c*((a=a/d-1)*a*((e+1)*a+e)+1)+b};
Math.easeInOutBack=function(a,b,c,d,e){void 0==e&&(e=1.70158);return 1>(a/=d/2)?c/2*a*a*(((e*=1.525)+1)*a-e)+b:c/2*((a-=2)*a*(((e*=1.525)+1)*a+e)+2)+b};Math.easeInBounce=function(a,b,c,d){return c-Math.easeOutBounce(d-a,0,c,d)+b};Math.easeOutBounce=function(a,b,c,d){return(a/=d)<1/2.75?c*7.5625*a*a+b:a<2/2.75?c*(7.5625*(a-=1.5/2.75)*a+0.75)+b:a<2.5/2.75?c*(7.5625*(a-=2.25/2.75)*a+0.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+0.984375)+b};
Math.easeInOutBounce=function(a,b,c,d){return a<d/2?0.5*Math.easeInBounce(2*a,0,c,d)+b:0.5*Math.easeOutBounce(2*a-d,0,c,d)+0.5*c+b};(function(){L7.Invoke=function(a){_.extend(this,a);this.reset()};L7.Invoke.prototype={reset:function(){this.done=!1},update:function(){this.done||(this.func(),this.done=!0)}}})();
(function(){L7.Plasma=function(a){_.extend(this,a);this._width=this._determineDim(this.targets,"x");this._height=this._determineDim(this.targets,"y");this._paletteOffset=0;this._palette=this._createPalette();this.reset()};L7.Plasma.prototype={reset:function(){this.done=!1;this._elapsed=0;this._doPlasma(this._width,this._height,this.targets,this._paletteOffset)},update:function(a){this._elapsed+=a;this._elapsed>=this.rate&&(this._paletteOffset+=1,this.done=!0)},_createPalette:function(){for(var a=
[],b=this.weights&&_.isNumber(this.weights[0])?this.weights[0]:1,c=this.weights&&_.isNumber(this.weights[1])?this.weights[1]:1,d=this.weights&&_.isNumber(this.weights[2])?this.weights[2]:1,e=this.alpha||1,f=this.noise||1,g=0,h,j,i;256>g;g++)h=~~(128+128*Math.sin(Math.PI*g/(32/f))),j=~~(128+128*Math.sin(Math.PI*g/(64/f))),i=~~(128+128*Math.sin(Math.PI*g/(128/f))),h=Math.min(255,h*b),j=Math.min(255,j*c),i=Math.min(255,i*d),a[g]=[h,j,i,e];return a},_determineDim:function(a,b){var c=Math.min.apply(null,
a.map(function(a){return a.position[b]}));return Math.max.apply(null,a.map(function(a){return a.position[b]}))-c+1},_doPlasma:function(a,b,c,d){for(var e=0,f;e<b;++e)for(f=0;f<a;++f){var g=c[a*e+f];g&&(g.overlayColor=this._palette[~~(0.25*(128*Math.sin(0.0625*f)+256+128*Math.sin(0.03125*e)+128+128*Math.sin(0.125*Math.sqrt((f+d-a)*(f+d-a)+(e-d-b)*(e-d-b)))+128+128*Math.sin(0.125*Math.sqrt(f*f+e*e)))+d)%256])}}}})();
(function(){L7.Repeat=function(a){this.children=[];this._curCount=this._currentChild=0;this.count=a};L7.Repeat.prototype={reset:function(){this.done=!1;this._curCount=this._currentChild=0;this.children.forEach(function(a){a.reset()})},update:function(){this.done=this._curCount>=this.count;if(!this.done){var a=this.children[this._currentChild];a.update.apply(a,arguments);a.done&&(++this._currentChild,this._currentChild>=this.children.length&&(this._currentChild=0,++this._curCount,this.children.forEach(function(a){a.reset()})));
this.done=this._curCount>=this.count}}}})();
(function(){L7.Shimmer=function(a){_.extend(this,a);this.reset()};L7.Shimmer.prototype={reset:function(){this.done=!1},_initTargets:function(){var a=this.maxAlpha-this.minAlpha,b=this.color||[255,255,255,1];this.targets.forEach(function(c){c.opaque=!0;c.overlayColor=b.slice(0);c.overlayColor[3]=L7.rand(this.minAlpha,this.maxAlpha);c.shimmerRate=Math.floor(L7.rand(this.baseRate-this.baseRate*this.rateVariance,this.baseRate+this.baseRate*this.rateVariance));c.shimmerAlphaPerMilli=a/c.shimmerRate;c.shimmerDirection=
1},this)},update:function(a){this._initted||(this._initTargets(),this._initted=!0);this.done||(this.targets.forEach(function(b){b.overlayColor[3]+=a*b.shimmerAlphaPerMilli*b.shimmerDirection;var c=b.overlayColor[3];c>this.maxAlpha&&(b.shimmerDirection=-1,b.overlayColor[3]=this.maxAlpha);c<this.minAlpha&&(b.shimmerDirection=1,b.overlayColor[3]=this.minAlpha)},this),this.done=!0)}}})();
(function(){L7.Together=function(){this.children=[]};L7.Together.prototype={reset:function(){this.done=!1;this.children.forEach(function(a){a.reset()})},update:function(){if(!this.done){var a=_.toArray(arguments),b=!1;this.children.forEach(function(c){c.update.apply(c,a);c.done||(b=!0)});this.done=!b}}}})();
(function(){var a=0;L7.Tween=function(b){_.extend(this,b);this.reset();this._saveProperty=this.property+"_save_"+a++;this._nonJitteredProperty=this.property+"_nonJittered_"+a++;this._easeFunc=(this._easeFunc=Math[this.easing||"linearTween"])||Math.linearTween};L7.Tween.prototype={reset:function(){this._elapsed=0;this.done=this._elapsed>=this.duration;this._initted=!1},_initTargets:function(){this.targets.forEach(function(a){a[this._saveProperty]=a[this.property];_.isArray(a[this._saveProperty])&&
(a[this._saveProperty]=a[this._saveProperty].slice(0));var c=this.from;_.isUndefined(c)||(_.isArray(c)&&(c=c.slice(0)),a[this.property]=c)},this)},update:function(a){this._initted||(this._initTargets(),this._initted=!0);!this.done&&!this.disabled&&(this._elapsed+=a,this._elapsed>this.duration&&(this._elapsed=this.duration,this.done=!0),this.targets.forEach(function(a){this._tween(a)},this),this.done&&this.targets.forEach(function(a){this.restoreAfter&&(a[this.property]=a[this._saveProperty]);delete a[this._saveProperty];
delete a[this._nonJitteredProperty]},this))},_tween:function(a){if(_.isArray(a[this.property]))for(var c=a[this.property],d=0;d<c.length;++d)c[d]=this._tweenValue(this._elapsed,(this.from||a[this._saveProperty])[d],this.to[d],this.duration);else _.isNumber(a[this.property])&&(a[this.property]=this._tweenValue(this._elapsed,this.from,this.to,this.duration))},_tweenValue:function(a,c,d,e){a=this._easeFunc(a,c,d-c,e);this.jitter&&(a+=L7.rand(-this.jitter,this.jitter));return a}}})();
(function(){L7.Wait=function(a){_.extend(this,a);this._specifiedDuration=this.duration;this.reset()};L7.Wait.prototype={reset:function(){this.duration=this._specifiedDuration||L7.rand(this.min,this.max);this._elapsed=0;this.done=this._elapsed>=this.duration},update:function(a){this.done||(this._elapsed+=a,this.done=this._elapsed>=this.duration)}}})();
(function(){L7.Actor=function(a){_.extend(this,a);this.ani=new L7.AnimationFactory(this);this.position=this.position||L7.p(0,0);this.shape=this.shape||[[5]];this.keyInputs=this.keyInputs||{};this.pieces=this._createPieces();this._listeners={}};L7.Actor.prototype={getAnimationTargets:function(a){return a?this.pieces.filter(a):this.pieces},on:function(a,b,c){this._listeners[a]||(this._listeners[a]=[]);this._listeners[a].push({handler:b,scope:c})},fireEvent:function(a,b){var c=this._listeners[a];if(_.isArray(c)){var d=
_.toArray(arguments);d.shift();_.each(c,function(a){a.handler.apply(a.scope,d)})}},_getAnchorOffset:function(){var a,b;for(b=0;b<this.shape.length;++b)for(a=0;a<this.shape[b].length;++a)if(this.shape[b][a]===L7.Actor.ANCHOR)return L7.p(a,b);throw Error("shape specified but lacks an anchor");},_getColor:function(a,b){return!this.color?void 0:_.isNumber(this.color[0])?this.color.slice(0):this.color[b][a].slice(0)},_createPieces:function(){for(var a=[],b=this._getAnchorOffset(),c=this.position,d=0;d<
this.shape.length;++d)for(var e=this.shape[d],f=0;f<e.length;++f)if(this.shape[d][f]){var g=L7.p(f,d).delta(b),g=c.add(g),h=this._getColor(f,d),g=new L7.Piece({position:g,color:h,isAnchor:this.shape[d][f]===L7.Actor.ANCHOR,owner:this,scale:_.isNumber(this.scale)?this.scale:1});g.isAnchor&&(this.anchorPiece=g);a.push(g)}return a},_getPiecePositionsAnchoredAt:function(a){var b=a.delta(this.position),c=[];_.each(this.pieces,function(a){c.push(a.position.add(b))});return c},left:function(a){this.goTo(this.position.add(-a,
0))},right:function(a){this.goTo(this.position.add(a,0))},up:function(a){this.goTo(this.position.add(0,-a))},down:function(a){this.goTo(this.position.add(0,a))},goBack:function(){this.goTo(this._lastPosition.clone())},goTo:function(a){if(!this.onGoTo||this.onGoTo(this._getPiecePositionsAnchoredAt(this.position),this._getPiecePositionsAnchoredAt(a),this.board))this._lastPosition=this.position.clone(),this.position=a,this.board&&this.board.moveActor({actor:this,from:this._lastPosition,to:this.position})},
update:function(a,b){this._updateKeyInputs(a,b);this._updateTimers(a);this._lastTimestamp=b},_updateKeyInputs:function(a){var b=!1;_(this.keyInputs).each(function(c,d){if(c.repeat&&L7.Keys.down(d)||L7.Keys.downSince(d,this._lastTimestamp||0)){if(b=!0,c._elapsed=c._elapsed||0,c._elapsed+=a,"undefined"===typeof c.enabled||c.enabled.call(this))if(!c.rate||c._elapsed>c.rate)c.handler.call(this,a),c._elapsed-=c.rate||0}else c._elapsed=0},this);if(!b&&this.onNoKeyDown)this.onNoKeyDown(a)},_updateTimers:function(a){this.timers&&
_.each(this.timers,function(b){if("undefined"===typeof b.enabled||!0===b.enabled||"function"===typeof b.enabled&&b.enabled.call(this))b.elapsed=b.elapsed||0,b.elapsed+=a,b.elapsed>=b.interval&&(b.elapsed-=b.interval,b.handler.call(this))},this)}};Object.defineProperty(L7.Actor,"ANCHOR",{get:function(){return 5},enumerable:!1})})();
(function(){L7.Board=function(a){_.extend(this,a||{});L7.useWebGL?_.extend(L7.Board.prototype,L7.WebGLBoardRenderMixin):_.extend(L7.Board.prototype,L7.CanvasBoardRenderMixin);this.ani=new L7.AnimationFactory(this,this);this.size=new L7.Pair(this.width||0,this.height||0);this.borderWidth=this.borderWidth||0;this.tileSize=this.tileSize||0;this._rows=[];this.tiles=[];for(a=0;a<this.height;++a){for(var b=[],c=0;c<this.width;++c){var d=new L7.Tile({x:c,y:a,board:this});d.color=_.clone(this.defaultTileColor);
b.push(d);this.tiles.push(d)}this._rows.push(b)}this.actors=[];this.freeActors=[];this.daemons=[];this.viewportWidth=Math.min(this.viewportWidth||this.width,this.width);this.viewportHeight=Math.min(this.viewportHeight||this.height,this.height);this.viewportAnchorX=this.viewportAnchor&&this.viewportAnchor.x||0;this.viewportAnchorY=this.viewportAnchor&&this.viewportAnchor.y||0;delete this.viewportAnchor;this._hitManager=new L7.HitManager};L7.Board.prototype={dump:function(){console.log("");console.log("");
this._rows.forEach(function(a){var b="";a.forEach(function(a){b=a.getColor()?a.inhabitants.length?b+"a":b+"t":b+"."});console.log(b)})},actorsOnTeam:function(a){return this.actors.filter(function(b){return b.team===a})},tilesTagged:function(a){return this.tiles.filter(function(b){return b.tag===a})},getAnimationTargets:function(a){return"tiles"===a?this.tiles:"board"===a?[this]:_.isArray(a)?a:this.tiles},destroy:function(){},_clamp:function(a,b,c){return a<b?b:a>=c?c:a},_tileToPixels:function(a){return(this.tileSize+
this.borderWidth)*a},scrollCenterOn:function(a){var b=this._tileToPixels(a.x)+this.tileSize/2,a=this._tileToPixels(a.y)+this.tileSize/2;this.viewport.centerOn(b,a)},scrollY:function(a){this.viewport&&this.viewport.scrollY(this._tileToPixels(a))},scrollX:function(a){this.viewport&&this.viewport.scrollX(this._tileToPixels(a))},scrollXY:function(a,b){this.scrollX(a);this.scrollY(b)},column:function(a){0>a&&(a=this.width+a);for(var b=[],c=0;c<this.height;++c)b.push(this.tileAt(L7.p(a,c)));return b},row:function(a){var b=
[];_.each(arguments,function(a){0>a&&(a=this.height+a);for(var d=0;d<this.width;++d)b.push(this.tileAt(L7.p(d,a)))},this);return b},rect:function(a,b,c,d){for(var e=[],f=b;f<b+d;++f)for(var g=a;g<a+c;++g)e.push(this.tileAt(g,f));return e},query:function(a){var b=[];this.tiles.forEach(function(c){a(c)&&b.push(c)});return b},tileAt:function(a,b){var c=_.isObject(a)?a.x:a,d=_.isNumber(b)?b:a.y;return 0>d||d>=this.height||0>c||c>=this.width?null:this.tiles[d*this.width+c]},tileAtPixels:function(a,b){var c=
_.isObject(a)?a.x:a,d=_.isNumber(b)?b:a.y;return this.tileAt(Math.floor(c/(this.tileSize+this.borderWidth)),Math.floor(d/(this.tileSize+this.borderWidth)))},pixelsForTile:function(a){return L7.p(this._tileToPixels(a.x),this._tileToPixels(a.y))},tileTopInPixels:function(a){return this._tileToPixels(a.y)},tileBottomInPixels:function(a){return this.tileTopInPixels(a)+this.tileSize},each:function(a,b){this.tiles.forEach(a,b)},_addPieces:function(a){a.forEach(function(a){var c=this.tileAt(a.position);
c&&c.add(a)},this)},_removePieces:function(a){a.forEach(function(a){var c=this.tileAt(a.position);c&&c.remove(a)},this)},promote:function(a){a.pieces&&(this._removePieces(a.pieces),this._addPieces(a.pieces))},addActor:function(a){a.pieces&&this._addPieces(a.pieces);this.actors.push(a);a.board=this},addFreeActor:function(a){this.freeActors.push(a);a.board=this},removeFreeActor:function(a){this.freeActors.remove(a);delete a.board},removeActor:function(a){a.pieces&&this._removePieces(a.pieces);this.actors.remove(a);
delete a.board},addDaemon:function(a){this.daemons.push(a)},removeDaemon:function(a){if(-1<this.daemons.indexOf(a)&&a.onRemove)a.onRemove(this);this.daemons.remove(a)},isOutOfBounds:function(a){for(var b=0,c=a.pieces.length;b<c;++b){var d=a.pieces[b].position;if(0>d.x||0>d.y||d.x>=this.width||d.y>=this.height)return!0}return!1},_movePiece:function(a,b){var c=a.position,d=a.position.add(b);(c=this.tileAt(c))&&c.remove(a);(c=this.tileAt(d))&&c.add(a);a.position=d},movePiece:function(a){this._movePiece(a.piece,
a.delta||a.to.delta(a.from))},moveActor:function(a){a.actor.pieces.forEach(function(b){this._movePiece(b,a.delta||a.to.delta(a.from))},this);a.actor.onOutOfBounds&&this.isOutOfBounds(a.actor)&&a.actor.onOutOfBounds.call(a.actor)},update:function(a,b){this.actors.forEach(function(c){c.update(a,b)});this.freeActors.forEach(function(c){c.update(a,b)});this.daemons.forEach(function(c){c.update(a,b,this)},this);this._hitManager.detectHits(this.tiles)}}})();
L7.CanvasBoardRenderMixin={render:function(a,b,c,d){this.angle&&(b.save(),b.rotate(this.angle));var c=c+(this.offsetX||0),d=d+(this.offsetY||0),e=this.borderWidth,a=this.tileSize,f=d/(a+e)|0,g=-d%(a+e),h,j=Math.min(this._rows.length,Math.ceil((d+b.canvas.height)/(a+e))),i=c/(a+e)|0,k=-c%(a+e),l,o=Math.min(this._rows[0].length,Math.ceil((c+b.canvas.width)/(a+e))),n,m,p,s=[];for(h=f;h<j;++h)if(0<=h){p=this._rows[h];for(l=i;l<o;++l)if(0<=l&&(n=p[l],m=n.getColor())){var r=n.getScale();_.isNumber(r)||
(r=1);var q=n.getOffset();if(1!==r||q&&(q.x||q.y))s.push(n),m=n.getColor(!0),r=1;m&&(this.borderFill&&(b.fillStyle=this.borderFill,b.fillRect((l-i)*(a+e)+k,(h-f)*(a+e)+g,a+2*e,e),b.fillRect((l-i)*(a+e)+k,(h-f)*(a+e)+g+a+e,a+2*e,e),b.fillRect((l-i)*(a+e)+k,(h-f)*(a+e)+g,e,a+2*e),b.fillRect((l-i)*(a+e)+k+a+e,(h-f)*(a+e)+g,e,a+2*e)),b.fillStyle=L7.Color.toCssString(m),m=Math.round(a*r),q=a/2-m/2,b.fillRect((l-i)*(a+e)+e+q+k,(h-f)*(a+e)+e+q+g,m,m))}}s.sort(function(a,b){return a.scale-b.scale});for(h=
0;h<s.length;++h)if(n=s[h],r=n.getScale(),_.isNumber(r)||(r=1),m=n.getColor())b.fillStyle=L7.Color.toCssString(m),m=a*r|0,q=n.getOffset(),l=j=0,q&&(j=a*q.x|0,l=a*q.y|0),q=a/2-m/2,b.fillRect((n.x-i)*(a+e)+e+q+k+j,(n.y-f)*(a+e)+e+q+g+l,m,m);for(h=0;h<this.freeActors.length;++h)if(e=this.freeActors[h],m=L7.Color.toCssString(e.color))b.fillStyle=m,b.fillRect(e.position.x-c,e.position.y-d,a,a);this.angle&&b.restore()}};
(function(){L7.HitManager=function(){};L7.HitManager.prototype={detectHits:function(a){a.forEach(function(a){this._detectTileHits(a)},this)},_detectTileHits:function(a){a.each(function(b){_.isObject(b.owner)&&_.isObject(b.owner.hitDetection)&&("undefined"===typeof b.owner.hitDetection.enabled||b.owner.hitDetection.enabled.call(b.owner))&&_.each(b.owner.hitDetection,function(c,d){a.tag===d&&c.call(b.owner,a,a);a.each(function(e){e!==b&&e.owner&&e.owner.team===d&&c.call(b.owner,a,e.owner)},this)},this)},
this)}}})();
(function(){L7.ParallaxBoard=function(a){_.extend(this,a);this.boards=this.boards||[];this.boards.forEach(function(a){if(!_.isNumber(a.parallaxRatio))throw Error("ParallaxBoard: given a board that lacks a parallax ratio");})};L7.ParallaxBoard.prototype={update:function(){var a=_.toArray(arguments);this.boards.forEach(function(b){b.update.apply(b,a)})},render:function(a,b,c,d,e){this.boards.forEach(function(f){f.render(a,b,c*f.parallaxRatio,d*f.parallaxRatio,e)})}};Object.defineProperty(L7.ParallaxBoard.prototype,"viewport",
{get:function(){return this.viewport},set:function(a){this.boards.forEach(function(b){b.viewport=a})},enumerable:!0})})();(function(){L7.Piece=function(a){_.extend(this,a||{})};L7.Piece.prototype={render:function(){this.sprite&&(this.sprite.overlay=this._overlay,this.sprite.render.apply(this.sprite,arguments))}};Object.defineProperty(L7.Piece.prototype,"overlay",{get:function(){return this._overlay},set:function(a){this._overlay=a},enumerable:!0})})();
(function(){L7.Tile=function(a){a=a||{};if(!_.isNumber(a.x))throw Error("Tile: x is required");if(!_.isNumber(a.y))throw Error("Tile: y is required");this.x=a.x;this.y=a.y;this.color=a.color;this.scale=a.scale;this.board=a.board;this.inhabitants=_.clone(a.inhabitants||[]);this.position=L7.p(this.x,this.y)};L7.Tile.prototype={at:function(a){return this.inhabitants[a]},each:function(a,b){this.inhabitants.forEach(a,b)},add:function(a){this.inhabitants.push(a)},remove:function(a){this.inhabitants.remove(a)},
has:function(a){return this.tag===a?!0:this.inhabitants.some(function(b){return b.team===a||b.owner&&b.owner.team===a})},hasOther:function(a,b){return this.tag===a?!0:this.inhabitants.some(function(c){return c.team===a||c.owner&&c.owner.team===a&&c.owner!==b})},getColor:function(a){var b=0;this.colors=this.colors||[];this.composite=this.composite||[];this.color&&(this.colors[b++]=this.color);if(!a)for(a=0;a<this.inhabitants.length;++a){var c=this.inhabitants[a].color;c&&(this.colors[b++]=c)}this.overlayColor&&
(this.colors[b++]=this.overlayColor);if(0<b)return L7.Color.composite(this.colors,b,this.composite),this.opaque&&(this.composite[3]=1),this.composite},getScale:function(){return 0===this.inhabitants.length||!this.inhabitants.last.color?this.scale:this.inhabitants.last.scale},getOffset:function(){return 0!==this.inhabitants.length&&this.inhabitants.last.offset},up:function(){return this.board&&this.board.tileAt(this.position.up())},down:function(){return this.board&&this.board.tileAt(this.position.down())},
left:function(){return this.board&&this.board.tileAt(this.position.left())},right:function(){return this.board&&this.board.tileAt(this.position.right())}};Object.defineProperty(L7.Tile.prototype,"count",{get:function(){return this.inhabitants.length},enumerable:!0})})();
(function(){var a=[0,0,0,0];L7.WebGLBoardRenderMixin={render:function(a,c,d,e){this.squareVertexPositionBuffer||this._glInit(c);d+=this.offsetX||0;e+=this.offsetY||0;mat4.identity(this.mvMatrix);mat4.translate(this.mvMatrix,[-d,-e,0]);c.uniformMatrix4fv(c.mvMatrixUniform,!1,this.mvMatrix);c.bindBuffer(c.ARRAY_BUFFER,this.squareVertexPositionBuffer);c.vertexAttribPointer(c.vertexPositionAttribute,this.squareVertexPositionBuffer.itemSize,c.FLOAT,!1,0,0);c.bindBuffer(c.ARRAY_BUFFER,this.centerVertexPositionBuffer);
c.vertexAttribPointer(c.centerPositionAttribute,this.centerVertexPositionBuffer.itemSize,c.FLOAT,!1,0,0);this._glSetTiles(c,d,e);c.drawArrays(c.TRIANGLES,0,this.squareVertexPositionBuffer.numItems)},_glInit:function(a){this.mvMatrix=mat4.create();this._glInitBuffer(a)},_glInitBuffer:function(a){function c(a,b,c){e[f++]=a;e[f++]=b;e[f++]=a+c;e[f++]=b;e[f++]=a+c;e[f++]=b+c;e[f++]=a;e[f++]=b;e[f++]=a+c;e[f++]=b+c;e[f++]=a;e[f++]=b+c}function d(a,b,c,d){var g=c+2*d;e[f++]=a;e[f++]=b;e[f++]=a+g;e[f++]=
b;e[f++]=a+g;e[f++]=b+d;e[f++]=a;e[f++]=b;e[f++]=a+g;e[f++]=b+d;e[f++]=a;e[f++]=b+d;var h=a+d+c;e[f++]=h;e[f++]=b;e[f++]=h+d;e[f++]=b;e[f++]=h+d;e[f++]=b+g;e[f++]=h;e[f++]=b;e[f++]=h+d;e[f++]=b+g;e[f++]=h;e[f++]=b+g;c=b+d+c;e[f++]=a;e[f++]=c;e[f++]=a+g;e[f++]=c;e[f++]=a+g;e[f++]=c+d;e[f++]=a;e[f++]=c;e[f++]=a+g;e[f++]=c+d;e[f++]=a;e[f++]=c+d;e[f++]=a;e[f++]=b;e[f++]=a+d;e[f++]=b;e[f++]=a+d;e[f++]=b+g;e[f++]=a;e[f++]=b;e[f++]=a+d;e[f++]=b+g;e[f++]=a;e[f++]=b+g}this.squareVertexPositionBuffer=a.createBuffer();
this.squareVertexPositionBuffer.itemSize=2;a.bindBuffer(a.ARRAY_BUFFER,this.squareVertexPositionBuffer);this.verticesPerTile=0<this.borderWidth?30:6;for(var e=new Float32Array(this.width*this.height*this.verticesPerTile*this.squareVertexPositionBuffer.itemSize),f=0,g=new Float32Array(2*this.width*this.height*this.verticesPerTile),h=0,j=this.tileSize,i=this.borderWidth,k=0;k<this.height;++k)for(var l=0;l<this.width;++l){var o=l*(j+i)+i,n=k*(j+i)+i;c(o,n,j);0<this.borderWidth&&d(o-i,n-i,j,i);for(var m=
0;m<this.verticesPerTile;++m)g[h++]=o+j/2,g[h++]=n+j/2}a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);this.squareVertexPositionBuffer.numItems=e.length/this.squareVertexPositionBuffer.itemSize;this.centerVertexPositionBuffer=a.createBuffer();this.centerVertexPositionBuffer.itemSize=2;a.bindBuffer(a.ARRAY_BUFFER,this.centerVertexPositionBuffer);a.bufferData(a.ARRAY_BUFFER,g,a.STATIC_DRAW);this.colorOffsetsBuffer=a.createBuffer();this.colorOffsetsBuffer.itemSize=6;g=new Float32Array(this.squareVertexPositionBuffer.numItems*
this.colorOffsetsBuffer.itemSize);a.bindBuffer(a.ARRAY_BUFFER,this.colorOffsetsBuffer);a.bufferData(a.ARRAY_BUFFER,g,a.DYNAMIC_DRAW)},_glSetTiles:function(b,c,d){var e=this.borderWidth,f=this.tileSize,g=d/(f+e)|0,d=Math.min(this.height,Math.ceil((d+this.viewport.height)/(f+e))),h=c/(f+e)|0,j,c=Math.min(this.width,Math.ceil((c+this.viewport.width)/(f+e))),i,e=this.borderFill?L7.Color.toArray(this.borderFill):a,k,f=c-Math.max(h,0);this.colorOffsetsData=this.colorOffsetsData||new Float32Array(f*this.verticesPerTile*
this.colorOffsetsBuffer.itemSize);for(b.bindBuffer(b.ARRAY_BUFFER,this.colorOffsetsBuffer);g<d;++g)if(0<=g){f=this._rows[g];k=0;for(j=h;j<c;++j)if(0<=j){i=f[j];i=i.getColor()||a;for(var l=0;6>l;++l)this.colorOffsetsData[k++]=i[0]/255,this.colorOffsetsData[k++]=i[1]/255,this.colorOffsetsData[k++]=i[2]/255,this.colorOffsetsData[k++]=i[3],this.colorOffsetsData[k++]=1,this.colorOffsetsData[k++]=1;if(0<this.borderWidth){i=i[3]?e:a;for(l=0;24>l;++l)this.colorOffsetsData[k++]=i[0]/255,this.colorOffsetsData[k++]=
i[1]/255,this.colorOffsetsData[k++]=i[2]/255,this.colorOffsetsData[k++]=i[3],this.colorOffsetsData[k++]=1,this.colorOffsetsData[k++]=1}}j=4;f=(g*this.width+Math.max(0,h))*this.verticesPerTile*this.colorOffsetsBuffer.itemSize*j;b.bufferSubData(b.ARRAY_BUFFER,f,this.colorOffsetsData)}b.vertexAttribPointer(b.vertexColorAttribute,4,b.FLOAT,!1,4*this.colorOffsetsBuffer.itemSize,0);b.vertexAttribPointer(b.offsetsAttribute,2,b.FLOAT,!1,this.colorOffsetsBuffer.itemSize*j,16)}}})();
(function(){function a(a){var a=a.substring(1),b=a.substring(0,2),e=a.substring(2,4),a=a.substring(4,6);return result=[parseInt(b,16),parseInt(e,16),parseInt(a,16),1]}L7.Color={toCssString:function(a){return 3===a.length?"rgb("+Math.round(a[0])+","+Math.round(a[1])+","+Math.round(a[2])+")":"rgba("+Math.round(a[0])+","+Math.round(a[1])+","+Math.round(a[2])+","+a[3]+")"},isBuiltInString:function(a){return"string"!==typeof a?!1:b.hasOwnProperty(a.toLowerCase())},isHexString:function(a){if("string"!==
typeof a||"#"!==a[0]||7!==a.length)return!1;for(var a=a.toUpperCase(),b=1,e=a.length;b<e;++b){var f=a[b];if("0">f||"F"<f)return!1}return!0},isOpaque:function(a){return this.isHexString(a)||this.isBuiltInString(a)?!0:(a=this.toArray(a))&&1===a[3]},isRgbString:function(a){return"string"!==typeof a||10>a.length||0!==a.indexOf("rgb")||")"!==a[a.length-1]||"("!==a[3]&&"("!==a[4]?!1:!0},toArray:function(c){if(_.isArray(c)&&4===c.length)return c;if(this.isHexString(c))return a(c);if(this.isBuiltInString(c))return a(b[c]);
if(this.isRgbString(c)){for(var d=c.indexOf("("),e=[],c=c.substring(d+1).split(","),d=0,f=c.length;d<f;++d)e.push(parseFloat(c[d]));3===e.length&&e.push(1);return e}},fromArrayToHex:function(a,b){for(var e="#",f=b&&b.includeAlpha&&4===a.length?4:3,g=0;g<f;++g){var h=a[g].toString(16);2>h.length&&(h="0"+h);e+=h}return e.toUpperCase()},composite:function(a,b,e){e[0]=e[1]=e[2]=e[3]=1;for(var f=0;f<b;++f){var g=e,h=a[f],j=h[3],i=g[3],k=1-j,l=void 0,o=void 0;for(l=0,o=g.length-1;l<o;++l)g[l]=Math.round(h[l]*
j+g[l]*i*k);g[3]=(g[3]+h[3])/2}},fromFloats:function(a,b,e,f){return[Math.round(255*a),Math.round(255*b),Math.round(255*e),f]}};var b={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",
cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",
firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",
lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370D8",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",
mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#D87093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",red:"#FF0000",
rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"}})();
(function(){L7.ColorLevelLoader=function(a,b,c,d){this.image=a;this.width=a.width;this.height=a.height;this.tileSize=b;this.borderWidth=c;this.borderFill=d||"black"};L7.ColorLevelLoader.prototype={load:function(){for(var a=new L7.Board(this),b=this._getData(),c=0;c<b.length;c+=4){var d=this._extractColor(b,c);if(0<d[3]){var e=this._getPosition(c);a.tileAt(e).color=d}}return a},_getData:function(){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;a=a.getContext("2d");a.drawImage(this.image,
0,0);return a.getImageData(0,0,this.width,this.height).data},_extractColor:function(a,b){for(var c=[],d=b;d<b+4;++d)c.push(a[d]);c[3]/=255;return c},_getPosition:function(a){a=Math.floor(a/4);return L7.p(a%this.width,Math.floor(a/this.width))}}})();
(function(){L7.ImageLoader=function(a){_.extend(this,a);this.loadNow&&this.load()};L7.ImageLoader.prototype={load:function(){this._pendingCount=this.srcs.length;this._images=[];var a=this;this.srcs.forEach(function(b){var c=new Image;c.onload=function(){var d=a.srcs.indexOf(b);a._images[d]=c;--a._pendingCount;0===a._pendingCount&&a.handler(a._images)};c.src=b})}}})();
(function(){L7.LevelLoader=function(a){_.extend(this,a);this.width=a.image.width;this.height=a.image.height};L7.LevelLoader.prototype={load:function(){for(var a=_.extend(this.boardConfig,{width:this.width,height:this.height}),b=new L7.Board(a),c={},a=this._getData(),d=0;d<a.length;d+=4){var e=this._extractColor(a,d),f=this.legend[e];if(f){var g=this._getPosition(d);if(f.hasOwnProperty("constructor")){var h=_.extend({},f.config||{},{position:g});_.isArray(f.constructor)||(f.constructor=[f.constructor]);
f.constructor.forEach(function(a){a=new a(h);c[e]=c[e]||[];c[e].push(a);b.addActor(a)})}f.tag&&(b.tileAt(g).tag=f.tag);f.color&&(b.tileAt(g).color=f.color)}}return{board:b,actors:c}},_getData:function(){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;a=a.getContext("2d");a.drawImage(this.image,0,0);return a.getImageData(0,0,this.width,this.height).data},_extractColor:function(a,b){for(var c=[],d=b;d<b+3;++d)c.push(a[d]);return L7.Color.fromArrayToHex(c)},_getPosition:function(a){a=
Math.floor(a/4);return L7.p(a%this.width,Math.floor(a/this.width))}}})();(function(){L7.CanvasGameRenderer=function(a){this.viewport=a};L7.CanvasGameRenderer.prototype={init:function(a){a.style.imageRendering="-webkit-optimize-contrast"},renderFrame:function(a,b,c,d,e,f){var g=a.getContext("2d");g.clearRect(0,0,a.width,a.height);b.render(c,g,d,e,f)}}})();
(function(){var a=1E3*(1/60);window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(b){window.setTimeout(b,a)};L7.Game=function(a){a="function"!==typeof a.render&&"function"!==typeof a.update?a:{width:a.width*(a.tileSize+a.borderWidth)+a.borderWidth,height:a.height*(a.tileSize+a.borderWidth)+a.borderWidth,board:a};_.extend(this,a);_.bindAll(this,"_doFrame");
this.viewport=new L7.Viewport(this);this.board&&(this.board.viewport=this.viewport);this.container=this.container||document.body;this.renderer=L7.useWebGL?new L7.WebGLGameRenderer(this.viewport):new L7.CanvasGameRenderer(this.viewport);this._createCanvas();this.renderer.init(this.canvas);L7.Keys.init(this.canvas);L7.Mouse.init(this.canvas);this.delays=[];var c=this;L7.global.addEventListener("blur",function(){delete c._lastTimestamp})};L7.Game.prototype={_createCanvas:function(){this.canvas=document.createElement("canvas");
this.canvas.width=this.viewport.width;this.canvas.height=this.viewport.height;this.container.appendChild(this.canvas)},go:function(){delete this._lastTimestamp;this._doFrame(Date.now())},after:function(a,c){this.delays.add({remaining:a,handler:c})},replaceBoard:function(a){this.board&&this.board.destroy&&this.board.destroy();this.board=a;this.board.viewport=this.viewport;this.viewport.reset()},_updateDelays:function(a){var c=[];this.delays.forEach(function(d){d.remaining-=a;0>=d.remaining&&(d.handler.call(d.scope,
this),c.push(d))},this);c.forEach(function(a){this.delays.remove(a)},this)},_displayFps:function(a){a=this._frameCount/((a-this._frameCountStart)/1E3);this.fpsContainer?this.fpsContainer.innerHTML=a:console.log("fps: "+a)},_updateFps:function(a){this._frameCountStart?(++this._frameCount,4E3<a-this._frameCountStart&&(this._displayFps(a),delete this._frameCountStart)):(this._frameCountStart=a,this._frameCount=1)},_doFrame:function(b){this._updateFps(b);var c=b-(this._lastTimestamp||b);this._lastTimestamp=
b;for(var d=c;0<d;){var e=Math.min(a,d);this._updateDelays(e);this.board.update(e,b);d-=e}this.renderer.renderFrame(this.canvas,this.board,c,this.viewport.anchorX,this.viewport.anchorY,b);this.paused||requestAnimationFrame(this._doFrame)}};Object.defineProperty(L7.Game.prototype,"paused",{get:function(){return this._paused},set:function(a){(this._paused=a)||this.go()}})})();
(function(){L7.Keys={arrows:{37:"left",38:"up",39:"right",40:"down"},init:function(){this._hook=window;this._keyDownListener=_.bind(this._onKeyDown,this);this._hook.addEventListener("keydown",this._keyDownListener,!1);this._keyUpListener=_.bind(this._onKeyUp,this);this._hook.addEventListener("keyup",this._keyUpListener,!1);this._downKeys={}},_getCharacter:function(a){return this.arrows[a.toString()]||String.fromCharCode(a).toLowerCase()},_onKeyDown:function(a){a=this._getCharacter(a.keyCode);this._downKeys[a]||
(this._downKeys[a]=Date.now())},_onKeyUp:function(a){delete this._downKeys[this._getCharacter(a.keyCode)]},down:function(a){return void 0!==this._downKeys[a]},downSince:function(a,b){return this.down(a)&&this._downKeys[a]>b}}})();
(function(){L7.Mouse={init:function(a){this._hook=a;this._mouseMoveListener=_.bind(this._onMouseMove,this);this._hook.addEventListener("mousemove",this._mouseMoveListener,!1);this._pos=L7.p()},_onMouseMove:function(a){this._pos=L7.p(a.offsetX,a.offsetY)}};Object.defineProperty(L7.Mouse,"position",{get:function(){return this._pos},enumerable:!0})})();
(function(){L7.Viewport=function(a){a=a||{};_.extend(this,a);_.isUndefined(this.preventOverscroll)&&(this.preventOverscroll=!1);this.anchorX=a.initialAnchor&&a.initialAnchor.x||0;this.anchorY=a.initialAnchor&&a.initialAnchor.y||0;this.width=this.width||100;this.height=this.height||100};L7.Viewport.prototype={scrollY:function(a){this.anchorY+=a},scrollX:function(a){this.anchorX+=a},centerOn:function(a,b){var c=a.y||b;this.anchorX=Math.floor((a.x||a)-this.width/2);this.anchorY=Math.floor(c-this.height/
2)},reset:function(){this.anchorY=this.anchorX=0}}})();
(function(){L7.WebGLGameRenderer=function(a){this.viewport=a};L7.WebGLGameRenderer.prototype={_getShader:function(a,b){var c=this.gl.createShader(b);this.gl.shaderSource(c,a);this.gl.compileShader(c);if(!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS))throw Error(this.gl.getShaderInfoLog(c));return c},_initShaders:function(){var a=this._getShader("precision lowp float;varying vec4 vColor;void main(void) {gl_FragColor = vColor;}",this.gl.FRAGMENT_SHADER),b=this._getShader("attribute vec2 aVertexPosition;attribute vec2 aOffsets;attribute vec2 aVertexCenter;attribute vec4 aVertexColor;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;varying vec4 vColor;void main(void) {float diffX = aVertexPosition.x - aVertexCenter.x;float offsetX = (aOffsets.x * diffX) - diffX;gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition + vec2(offsetX, 0), 0.0, 1.0);vColor = aVertexColor;}",
this.gl.VERTEX_SHADER),c=this.gl.createProgram();this.gl.attachShader(c,b);this.gl.attachShader(c,a);this.gl.linkProgram(c);if(!this.gl.getProgramParameter(c,this.gl.LINK_STATUS))throw Error("Could not initialise shaders");this.gl.useProgram(c);this.gl.vertexPositionAttribute=this.gl.getAttribLocation(c,"aVertexPosition");this.gl.enableVertexAttribArray(this.gl.vertexPositionAttribute);this.gl.offsetsAttribute=this.gl.getAttribLocation(c,"aOffsets");console.log("offsetsAttribute: "+this.gl.offsetsAttribute);
this.gl.enableVertexAttribArray(this.gl.offsetsAttribute);this.gl.centerPositionAttribute=this.gl.getAttribLocation(c,"aVertexCenter");this.gl.enableVertexAttribArray(this.gl.centerPositionAttribute);this.gl.vertexColorAttribute=this.gl.getAttribLocation(c,"aVertexColor");this.gl.enableVertexAttribArray(this.gl.vertexColorAttribute);this.pMatrixUniform=this.gl.getUniformLocation(c,"uPMatrix");this.gl.mvMatrixUniform=this.gl.getUniformLocation(c,"uMVMatrix")},init:function(a){this.gl=a.getContext("experimental-webgl");
this.gl.clearColor(0,0,0,1);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.enable(this.gl.BLEND);this.pMatrix=mat4.create();this._initShaders()},renderFrame:function(a,b,c,d,e,f){this.gl.viewport(0,0,this.viewport.width,this.viewport.height);this.gl.clear(this.gl.COLOR_BUFFER_BIT);mat4.ortho(0,this.viewport.width,this.viewport.height,0,-100,100,this.pMatrix);this.gl.uniformMatrix4fv(this.pMatrixUniform,!1,this.pMatrix);b.render(c,this.gl,d,e,f)}}})();
(function(){var a=Math.PI,b=2*a,c=a/2;L7.Pair=function(a,b){this._a=a||0;this._b=b||0};L7.Pair.prototype={clone:function(){return L7.p(this.x,this.y)},equals:function(a){return a?a===this||a._a===this._a&&a._b==this._b||a.x===this._a&&a.y==this._b||a.width==this._a&&a.height==this._b:!1},up:function(){return L7.p(this.x,this.y-1)},left:function(){return L7.p(this.x-1,this.y)},right:function(){return L7.p(this.x+1,this.y)},down:function(){return L7.p(this.x,this.y+1)},add:function(a,b){return L7.p(this.x+
("number"===typeof a.x?a.x:a||0),this.y+("number"===typeof a.y?a.y:b||0))},subtract:function(a,b){x="number"===typeof a.x?a.x:a||0;y="number"===typeof a.y?a.y:b||0;return L7.p(this.x-x,this.y-y)},negate:function(){return L7.p(-this.x,-this.y)},multiply:function(a){return L7.p(this.x*a,this.y*a)},round:function(){return L7.pr(this.x,this.y)},dot:function(a){return this.x*a.x+this.y*a.y},length:function(){return Math.sqrt(this.dot(this))},normalize:function(){return this.multiply(1/this.length())},
distanceFrom:function(a){a=this.delta(a);return Math.sqrt(a.dot(a))},degreeAngleFrom:function(a){return L7.radiansToDegrees(this.radianAngleFrom(a))},radianAngleFrom:function(d){var e=this.x-d.x,d=this.y-d.y;if(0===e)return 0>d?3*c:c;if(0===d)return 0>e?a:0;var f=Math.atan(d/e);return 0<e&&0<d?f:0>e&&0<d?f+a:0>e&&0>d?f+a:f+b},toString:function(){return"["+this._a+","+this._b+"]"}};L7.Pair.prototype.delta=L7.Pair.prototype.subtract;Object.defineProperty(L7.Pair.prototype,"width",{get:function(){return this._a}});
Object.defineProperty(L7.Pair.prototype,"height",{get:function(){return this._b}});Object.defineProperty(L7.Pair.prototype,"x",{get:function(){return this._a}});Object.defineProperty(L7.Pair.prototype,"y",{get:function(){return this._b}});L7.s=function(a,b){return new L7.Pair(a,b)};L7.p=L7.s;L7.sr=function(a,b){return new L7.Pair(Math.round(a),Math.round(b))};L7.pr=L7.sr})();
(function(){function a(){return L7.rand(-1,1,!0)}var b=0;L7.ParticleSystem=function(a){_.extend(this,a);this._particles=[];this.id=b++;this._particleTeam=this.team||"particle-"+this.id;for(a=0;a<this.totalParticles;++a)this._particles.push(new L7.Actor({position:this.position.clone(),team:this._particleTeam}));this._particleCount=this._particleIndex=this._emitCounter=this._elapsed=0;this.active=this.active||!1};L7.ParticleSystem.prototype={onRemove:function(a){this.reset();this._particles.forEach(function(b){this._initParticle(b);
a.removeActor(b)},this);this._addedActors=!1},reset:function(){this._particleIndex=this._particleCount=0},_isFull:function(){return this._particleCount===this.totalParticles},_initParticle:function(b){b.rx=this.position.x+this.posVar.x*a();b.ry=this.position.y+this.posVar.y*a();var d=L7.degreesToRadians(this.angle+this.angleVar*a()),d=L7.p(Math.cos(d),Math.sin(d)),e=this.speed+this.speedVar*a(),d=d.multiply(e);b.dir={x:d.x,y:d.y};b.radialAccel=this.radialAccel+this.radialAccelVar*a();b.radialAccel&&
(b.radialAccel=0);b.tangentialAccel=this.tangentialAccel+this.tangentialAccelVar*a();b.tangentialAccel||(b.tangentialAccel=0);d=this.life+this.lifeVar*a();b.life=Math.max(0,d);d=[this.startColor[0]+this.startColorVar[0]*a(),this.startColor[1]+this.startColorVar[1]*a(),this.startColor[2]+this.startColorVar[2]*a(),this.startColor[3]+this.startColorVar[3]*a()];e=[this.endColor[0]+this.endColorVar[0]*a(),this.endColor[1]+this.endColorVar[1]*a(),this.endColor[2]+this.endColorVar[2]*a(),this.endColor[3]+
this.endColorVar[3]*a()];b.color=d;b.pieces[0].color=d;b.deltaColor=[(e[0]-d[0])/b.life,(e[1]-d[1])/b.life,(e[2]-d[2])/b.life,(e[3]-d[3])/b.life];_.isUndefined(this.startSize)?(b.size=1,b.deltaSize=0):(d=this.startSize+this.startSizeVar*a(),d=Math.max(0,d),b.size=d,_.isUndefined(this.endSize)?b.deltaSize=0:(e=this.endSize+this.endSizeVar*a(),b.deltaSize=(e-d)/b.life))},_addParticle:function(){if(this._isFull())return!1;this._initParticle(this._particles[this._particleCount]);++this._particleCount;
return!0},update:function(a,b,e){if(this.active){a/=1E3;if(this.emissionRate){b=1/this.emissionRate;for(this._emitCounter+=a;!this._isFull()&&this._emitCounter>b;)this._addParticle(),this._emitCounter-=b}this._elapsed+=a;this.active=this._elapsed<this.duration;for(this._particleIndex=0;this._particleIndex<this._particleCount;)this._updateParticle(this._particles[this._particleIndex],a,this._particleIndex);this._updateBoard(e)}},_updateParticle:function(a,b,e){if(0<a.life){var f=e=0,f={x:0,y:0};if(a.position.x!==
this.position.x||a.position.y!==this.position.y)e=L7.p(a.rx,a.ry).normalize(),f={x:e.x,y:e.y};var g=_.clone(f);f.x*=a.radialAccel;f.y*=a.radialAccel;e=g.x;g.x=-g.y;g.y=e;g.x*=a.tangentialAccel;g.y*=a.tangentialAccel;e=f.x+g.x+this.gravity.x;f=f.y+g.y+this.gravity.y;a.dir.x+=e*b;a.dir.y+=f*b;e=a.dir.x*b;f=a.dir.y*b;a.rx+=e;a.ry+=f;a.goTo(L7.pr(a.rx,a.ry));a.color[0]+=a.deltaColor[0]*b;a.color[1]+=a.deltaColor[1]*b;a.color[2]+=a.deltaColor[2]*b;a.color[3]+=a.deltaColor[3]*b;a.size+=a.deltaSize*b;a.size=
Math.max(0,a.size);a.pieces[0].scale=a.size;a.life-=b;++this._particleIndex}else a=this._particles[e],this._particles[e]=this._particles[this._particleCount-1],this._particles[this._particleCount-1]=a,--this._particleCount},_updateBoard:function(a){this._addedActors||(this._particles.forEach(function(b){a.addActor(b)}),this._addedActors=!0);for(var b=L7.p(-1,-1),e=this._particleCount;e<this._particles.length;++e)this._particles[e].goTo(b)}}})();
(function(a){a.glMatrixArrayType=a.MatrixArray=null;a.vec3={};a.mat3={};a.mat4={};a.quat4={};a.setMatrixArrayType=function(a){return glMatrixArrayType=MatrixArray=a};a.determineMatrixArrayType=function(){return setMatrixArrayType("undefined"!==typeof Float32Array?Float32Array:Array)};determineMatrixArrayType()})("undefined"!=typeof exports?global:this);vec3.create=function(a){var b=new MatrixArray(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):b[0]=b[1]=b[2]=0;return b};
vec3.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b};vec3.add=function(a,b,c){if(!c||a===c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c};vec3.subtract=function(a,b,c){if(!c||a===c)return a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a;c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c};vec3.multiply=function(a,b,c){if(!c||a===c)return a[0]*=b[0],a[1]*=b[1],a[2]*=b[2],a;c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];return c};
vec3.negate=function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b};vec3.scale=function(a,b,c){if(!c||a===c)return a[0]*=b,a[1]*=b,a[2]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c};vec3.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);if(f){if(1===f)return b[0]=c,b[1]=d,b[2]=e,b}else return b[0]=0,b[1]=0,b[2]=0,b;f=1/f;b[0]=c*f;b[1]=d*f;b[2]=e*f;return b};
vec3.cross=function(a,b,c){c||(c=a);var d=a[0],e=a[1],a=a[2],f=b[0],g=b[1],b=b[2];c[0]=e*b-a*g;c[1]=a*f-d*b;c[2]=d*g-e*f;return c};vec3.length=function(a){var b=a[0],c=a[1],a=a[2];return Math.sqrt(b*b+c*c+a*a)};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.direction=function(a,b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1],a=a[2]-b[2],b=Math.sqrt(d*d+e*e+a*a);if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/b;c[0]=d*b;c[1]=e*b;c[2]=a*b;return c};
vec3.lerp=function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return d};vec3.dist=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)};
vec3.unproject=function(a,b,c,d,e){e||(e=a);var f=mat4.create(),g=new MatrixArray(4);g[0]=2*(a[0]-d[0])/d[2]-1;g[1]=2*(a[1]-d[1])/d[3]-1;g[2]=2*a[2]-1;g[3]=1;mat4.multiply(c,b,f);if(!mat4.inverse(f))return null;mat4.multiplyVec4(f,g);if(0===g[3])return null;e[0]=g[0]/g[3];e[1]=g[1]/g[3];e[2]=g[2]/g[3];return e};vec3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};
mat3.create=function(a){var b=new MatrixArray(9);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8]);return b};mat3.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return b};mat3.identity=function(a){a||(a=mat3.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a};
mat3.transpose=function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=d;a[7]=e;return a}b[0]=a[0];b[1]=a[3];b[2]=a[6];b[3]=a[1];b[4]=a[4];b[5]=a[7];b[6]=a[2];b[7]=a[5];b[8]=a[8];return b};mat3.toMat4=function(a,b){b||(b=mat4.create());b[15]=1;b[14]=0;b[13]=0;b[12]=0;b[11]=0;b[10]=a[8];b[9]=a[7];b[8]=a[6];b[7]=0;b[6]=a[5];b[5]=a[4];b[4]=a[3];b[3]=0;b[2]=a[2];b[1]=a[1];b[0]=a[0];return b};
mat3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"};mat4.create=function(a){var b=new MatrixArray(16);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);return b};
mat4.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b};mat4.identity=function(a){a||(a=mat4.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};
mat4.transpose=function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[3],f=a[6],g=a[7],h=a[11];a[1]=a[4];a[2]=a[8];a[3]=a[12];a[4]=c;a[6]=a[9];a[7]=a[13];a[8]=d;a[9]=f;a[11]=a[14];a[12]=e;a[13]=g;a[14]=h;return a}b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b};
mat4.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],j=a[7],i=a[8],k=a[9],l=a[10],o=a[11],n=a[12],m=a[13],p=a[14],a=a[15];return n*k*h*e-i*m*h*e-n*g*l*e+f*m*l*e+i*g*p*e-f*k*p*e-n*k*d*j+i*m*d*j+n*c*l*j-b*m*l*j-i*c*p*j+b*k*p*j+n*g*d*o-f*m*d*o-n*c*h*o+b*m*h*o+f*c*p*o-b*g*p*o-i*g*d*a+f*k*d*a+i*c*h*a-b*k*h*a-f*c*l*a+b*g*l*a};
mat4.inverse=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],j=a[6],i=a[7],k=a[8],l=a[9],o=a[10],n=a[11],m=a[12],p=a[13],s=a[14],r=a[15],q=c*h-d*g,D=c*j-e*g,u=c*i-f*g,v=d*j-e*h,w=d*i-f*h,z=e*i-f*j,A=k*p-l*m,B=k*s-o*m,C=k*r-n*m,E=l*s-o*p,F=l*r-n*p,G=o*r-n*s,t=q*G-D*F+u*E+v*C-w*B+z*A;if(!t)return null;t=1/t;b[0]=(h*G-j*F+i*E)*t;b[1]=(-d*G+e*F-f*E)*t;b[2]=(p*z-s*w+r*v)*t;b[3]=(-l*z+o*w-n*v)*t;b[4]=(-g*G+j*C-i*B)*t;b[5]=(c*G-e*C+f*B)*t;b[6]=(-m*z+s*u-r*D)*t;b[7]=(k*z-o*u+n*D)*t;b[8]=
(g*F-h*C+i*A)*t;b[9]=(-c*F+d*C-f*A)*t;b[10]=(m*w-p*u+r*q)*t;b[11]=(-k*w+l*u-n*q)*t;b[12]=(-g*E+h*B-j*A)*t;b[13]=(c*E-d*B+e*A)*t;b[14]=(-m*v+p*D-s*q)*t;b[15]=(k*v-l*D+o*q)*t;return b};mat4.toRotationMat=function(a,b){b||(b=mat4.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};
mat4.toMat3=function(a,b){b||(b=mat3.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[4];b[4]=a[5];b[5]=a[6];b[6]=a[8];b[7]=a[9];b[8]=a[10];return b};mat4.toInverseMat3=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[4],g=a[5],h=a[6],j=a[8],i=a[9],k=a[10],l=k*g-h*i,o=-k*f+h*j,n=i*f-g*j,m=c*l+d*o+e*n;if(!m)return null;m=1/m;b||(b=mat3.create());b[0]=l*m;b[1]=(-k*d+e*i)*m;b[2]=(h*d-e*g)*m;b[3]=o*m;b[4]=(k*c-e*j)*m;b[5]=(-h*c+e*f)*m;b[6]=n*m;b[7]=(-i*c+d*j)*m;b[8]=(g*c-d*f)*m;return b};
mat4.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],j=a[5],i=a[6],k=a[7],l=a[8],o=a[9],n=a[10],m=a[11],p=a[12],s=a[13],r=a[14],a=a[15],q=b[0],D=b[1],u=b[2],v=b[3],w=b[4],z=b[5],A=b[6],B=b[7],C=b[8],E=b[9],F=b[10],G=b[11],t=b[12],H=b[13],I=b[14],b=b[15];c[0]=q*d+D*h+u*l+v*p;c[1]=q*e+D*j+u*o+v*s;c[2]=q*f+D*i+u*n+v*r;c[3]=q*g+D*k+u*m+v*a;c[4]=w*d+z*h+A*l+B*p;c[5]=w*e+z*j+A*o+B*s;c[6]=w*f+z*i+A*n+B*r;c[7]=w*g+z*k+A*m+B*a;c[8]=C*d+E*h+F*l+G*p;c[9]=C*e+E*j+F*o+G*s;c[10]=C*f+E*
i+F*n+G*r;c[11]=C*g+E*k+F*m+G*a;c[12]=t*d+H*h+I*l+b*p;c[13]=t*e+H*j+I*o+b*s;c[14]=t*f+H*i+I*n+b*r;c[15]=t*g+H*k+I*m+b*a;return c};mat4.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c};
mat4.multiplyVec4=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2],b=b[3];c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*b;c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*b;c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*b;c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*b;return c};
mat4.translate=function(a,b,c){var d=b[0],e=b[1],b=b[2],f,g,h,j,i,k,l,o,n,m,p,s;if(!c||a===c)return a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a;f=a[0];g=a[1];h=a[2];j=a[3];i=a[4];k=a[5];l=a[6];o=a[7];n=a[8];m=a[9];p=a[10];s=a[11];c[0]=f;c[1]=g;c[2]=h;c[3]=j;c[4]=i;c[5]=k;c[6]=l;c[7]=o;c[8]=n;c[9]=m;c[10]=p;c[11]=s;c[12]=f*d+i*e+n*b+a[12];c[13]=g*d+k*e+m*b+a[13];c[14]=h*d+l*e+p*b+a[14];c[15]=j*d+o*e+s*b+a[15];
return c};mat4.scale=function(a,b,c){var d=b[0],e=b[1],b=b[2];if(!c||a===c)return a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=b,a[9]*=b,a[10]*=b,a[11]*=b,a;c[0]=a[0]*d;c[1]=a[1]*d;c[2]=a[2]*d;c[3]=a[3]*d;c[4]=a[4]*e;c[5]=a[5]*e;c[6]=a[6]*e;c[7]=a[7]*e;c[8]=a[8]*b;c[9]=a[9]*b;c[10]=a[10]*b;c[11]=a[11]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c};
mat4.rotate=function(a,b,c,d){var e=c[0],f=c[1],c=c[2],g=Math.sqrt(e*e+f*f+c*c),h,j,i,k,l,o,n,m,p,s,r,q,D,u,v,w,z,A,B,C;if(!g)return null;1!==g&&(g=1/g,e*=g,f*=g,c*=g);h=Math.sin(b);j=Math.cos(b);i=1-j;b=a[0];g=a[1];k=a[2];l=a[3];o=a[4];n=a[5];m=a[6];p=a[7];s=a[8];r=a[9];q=a[10];D=a[11];u=e*e*i+j;v=f*e*i+c*h;w=c*e*i-f*h;z=e*f*i-c*h;A=f*f*i+j;B=c*f*i+e*h;C=e*c*i+f*h;e=f*c*i-e*h;f=c*c*i+j;d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a;d[0]=b*u+o*v+s*w;d[1]=g*u+n*v+r*w;d[2]=k*u+m*v+q*
w;d[3]=l*u+p*v+D*w;d[4]=b*z+o*A+s*B;d[5]=g*z+n*A+r*B;d[6]=k*z+m*A+q*B;d[7]=l*z+p*A+D*B;d[8]=b*C+o*e+s*f;d[9]=g*C+n*e+r*f;d[10]=k*C+m*e+q*f;d[11]=l*C+p*e+D*f;return d};mat4.rotateX=function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[4],f=a[5],g=a[6],h=a[7],j=a[8],i=a[9],k=a[10],l=a[11];c?a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[4]=e*b+j*d;c[5]=f*b+i*d;c[6]=g*b+k*d;c[7]=h*b+l*d;c[8]=e*-d+j*b;c[9]=f*-d+i*b;c[10]=g*-d+k*b;c[11]=h*-d+l*b;return c};
mat4.rotateY=function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[0],f=a[1],g=a[2],h=a[3],j=a[8],i=a[9],k=a[10],l=a[11];c?a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+j*-d;c[1]=f*b+i*-d;c[2]=g*b+k*-d;c[3]=h*b+l*-d;c[8]=e*d+j*b;c[9]=f*d+i*b;c[10]=g*d+k*b;c[11]=h*d+l*b;return c};
mat4.rotateZ=function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[0],f=a[1],g=a[2],h=a[3],j=a[4],i=a[5],k=a[6],l=a[7];c?a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+j*d;c[1]=f*b+i*d;c[2]=g*b+k*d;c[3]=h*b+l*d;c[4]=e*-d+j*b;c[5]=f*-d+i*b;c[6]=g*-d+k*b;c[7]=h*-d+l*b;return c};
mat4.frustum=function(a,b,c,d,e,f,g){g||(g=mat4.create());var h=b-a,j=d-c,i=f-e;g[0]=2*e/h;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2*e/j;g[6]=0;g[7]=0;g[8]=(b+a)/h;g[9]=(d+c)/j;g[10]=-(f+e)/i;g[11]=-1;g[12]=0;g[13]=0;g[14]=-(2*f*e)/i;g[15]=0;return g};mat4.perspective=function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b*=a;return mat4.frustum(-b,b,-a,a,c,d,e)};
mat4.ortho=function(a,b,c,d,e,f,g){g||(g=mat4.create());var h=b-a,j=d-c,i=f-e;g[0]=2/h;g[1]=0;g[2]=0;g[3]=0;g[4]=0;g[5]=2/j;g[6]=0;g[7]=0;g[8]=0;g[9]=0;g[10]=-2/i;g[11]=0;g[12]=-(a+b)/h;g[13]=-(d+c)/j;g[14]=-(f+e)/i;g[15]=1;return g};
mat4.lookAt=function(a,b,c,d){d||(d=mat4.create());var e,f,g,h,j,i,k,l,o=a[0],n=a[1],a=a[2];g=c[0];h=c[1];f=c[2];k=b[0];c=b[1];e=b[2];if(o===k&&n===c&&a===e)return mat4.identity(d);b=o-k;c=n-c;k=a-e;l=1/Math.sqrt(b*b+c*c+k*k);b*=l;c*=l;k*=l;e=h*k-f*c;f=f*b-g*k;g=g*c-h*b;(l=Math.sqrt(e*e+f*f+g*g))?(l=1/l,e*=l,f*=l,g*=l):g=f=e=0;h=c*g-k*f;j=k*e-b*g;i=b*f-c*e;(l=Math.sqrt(h*h+j*j+i*i))?(l=1/l,h*=l,j*=l,i*=l):i=j=h=0;d[0]=e;d[1]=h;d[2]=b;d[3]=0;d[4]=f;d[5]=j;d[6]=c;d[7]=0;d[8]=g;d[9]=i;d[10]=k;d[11]=
0;d[12]=-(e*o+f*n+g*a);d[13]=-(h*o+j*n+i*a);d[14]=-(b*o+c*n+k*a);d[15]=1;return d};mat4.fromRotationTranslation=function(a,b,c){c||(c=mat4.create());var d=a[0],e=a[1],f=a[2],g=a[3],h=d+d,j=e+e,i=f+f,a=d*h,k=d*j,d=d*i,l=e*j,e=e*i,f=f*i,h=g*h,j=g*j,g=g*i;c[0]=1-(l+f);c[1]=k+g;c[2]=d-j;c[3]=0;c[4]=k-g;c[5]=1-(a+f);c[6]=e+h;c[7]=0;c[8]=d+j;c[9]=e-h;c[10]=1-(a+l);c[11]=0;c[12]=b[0];c[13]=b[1];c[14]=b[2];c[15]=1;return c};
mat4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"};quat4.create=function(a){var b=new MatrixArray(4);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]);return b};quat4.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};
quat4.calculateW=function(a,b){var c=a[0],d=a[1],e=a[2];if(!b||a===b)return a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a;b[0]=c;b[1]=d;b[2]=e;b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return b};quat4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};quat4.inverse=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],c=(c=c*c+d*d+e*e+f*f)?1/c:0;if(!b||a===b)return a[0]*=-c,a[1]*=-c,a[2]*=-c,a[3]*=c,a;b[0]=-a[0]*c;b[1]=-a[1]*c;b[2]=-a[2]*c;b[3]=a[3]*c;return b};
quat4.conjugate=function(a,b){if(!b||a===b)return a[0]*=-1,a[1]*=-1,a[2]*=-1,a;b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=a[3];return b};quat4.length=function(a){var b=a[0],c=a[1],d=a[2],a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)};quat4.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=Math.sqrt(c*c+d*d+e*e+f*f);if(0===g)return b[0]=0,b[1]=0,b[2]=0,b[3]=0,b;g=1/g;b[0]=c*g;b[1]=d*g;b[2]=e*g;b[3]=f*g;return b};
quat4.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],a=a[3],g=b[0],h=b[1],j=b[2],b=b[3];c[0]=d*b+a*g+e*j-f*h;c[1]=e*b+a*h+f*g-d*j;c[2]=f*b+a*j+d*h-e*g;c[3]=a*b-d*g-e*h-f*j;return c};quat4.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2],b=a[0],g=a[1],h=a[2],a=a[3],j=a*d+g*f-h*e,i=a*e+h*d-b*f,k=a*f+b*e-g*d,d=-b*d-g*e-h*f;c[0]=j*a+d*-b+i*-h-k*-g;c[1]=i*a+d*-g+k*-b-j*-h;c[2]=k*a+d*-h+j*-g-i*-b;return c};
quat4.toMat3=function(a,b){b||(b=mat3.create());var c=a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,j=e+e,i=c*g,k=c*h,c=c*j,l=d*h,d=d*j,e=e*j,g=f*g,h=f*h,f=f*j;b[0]=1-(l+e);b[1]=k+f;b[2]=c-h;b[3]=k-f;b[4]=1-(i+e);b[5]=d+g;b[6]=c+h;b[7]=d-g;b[8]=1-(i+l);return b};
quat4.toMat4=function(a,b){b||(b=mat4.create());var c=a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,j=e+e,i=c*g,k=c*h,c=c*j,l=d*h,d=d*j,e=e*j,g=f*g,h=f*h,f=f*j;b[0]=1-(l+e);b[1]=k+f;b[2]=c-h;b[3]=0;b[4]=k-f;b[5]=1-(i+e);b[6]=d+g;b[7]=0;b[8]=c+h;b[9]=d-g;b[10]=1-(i+l);b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};
quat4.slerp=function(a,b,c,d){d||(d=a);var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3],f,g;if(1<=Math.abs(e))return d!==a&&(d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=a[3]),d;f=Math.acos(e);g=Math.sqrt(1-e*e);if(0.0010>Math.abs(g))return d[0]=0.5*a[0]+0.5*b[0],d[1]=0.5*a[1]+0.5*b[1],d[2]=0.5*a[2]+0.5*b[2],d[3]=0.5*a[3]+0.5*b[3],d;e=Math.sin((1-c)*f)/g;c=Math.sin(c*f)/g;d[0]=a[0]*e+b[0]*c;d[1]=a[1]*e+b[1]*c;d[2]=a[2]*e+b[2]*c;d[3]=a[3]*e+b[3]*c;return d};
quat4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};
(function(){L7.FadeBase=function(a){_.extend(this,a);this.elapsed=0;this.color&&(this.color=L7.Color.toArray(this.color))};L7.FadeBase.prototype={update:function(a,b){this.elapsed+=a;var c=this.elapsed/this.duration;this.updateColor(this.color,c);if(1<c&&this.onComplete)this.onComplete(this);this.board.update(a,b)},render:function(a,b,c,d,e){this.board.render(a,b,c,d,e);b.save();b.fillStyle=L7.Color.toCssString(this.color);b.fillRect(0,0,b.canvas.width,b.canvas.height);b.restore()}};Object.defineProperty(L7.FadeBase.prototype,
"viewport",{set:function(a){this._viewport=a;this.board&&(this.board.viewport=a)},get:function(){return this._viewport},enumerable:!0})})();(function(){L7.FadeIn=function(a){a.color=a.from;L7.FadeBase.call(this,a)};L7.FadeIn.prototype=new L7.FadeBase;L7.FadeIn.prototype.updateColor=function(a,b){a[3]=1-b}})();(function(){L7.FadeOut=function(a){a.color=a.to;L7.FadeBase.call(this,a)};L7.FadeOut.prototype=new L7.FadeBase;L7.FadeOut.prototype.updateColor=function(a,b){a[3]=b}})();
(function(){L7.FadeOutIn=function(a){_.extend(this,a);_.bindAll(this,"_onFadeOutComplete","_onFadeInComplete");this.delegate=new L7.FadeOut({board:this.fromBoard,to:this.color,duration:this.duration/2,onComplete:this._onFadeOutComplete})};L7.FadeOutIn.prototype={_onFadeOutComplete:function(){this.delegate=new L7.FadeIn({board:this.toBoard,from:this.color,duration:this.duration/2,onComplete:this._onFadeInComplete});this.delegate.viewport=this.viewport},_onFadeInComplete:function(){if(this.onComplete)this.onComplete();
else this.game&&this.game.replaceBoard(this.toBoard)},update:function(){this.delegate.update.apply(this.delegate,arguments)},render:function(){this.delegate.render.apply(this.delegate,arguments)}};Object.defineProperty(L7.FadeOutIn.prototype,"viewport",{set:function(a){this._viewport=a;this.delegate&&(this.delegate.viewport=a)},get:function(){return this._viewport},enumerable:!0})})();
(function(){"undefined"===typeof Array.prototype.add&&(Array.prototype.add=function(a){this.push(a);return this});"undefined"===typeof Array.prototype.remove&&(Array.prototype.remove=function(a){a=this.indexOf(a);0<=a&&this.splice(a,1);return this});"undefined"===typeof Array.prototype.last&&Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]},enumerable:!1});"undefined"===typeof Array.prototype.first&&Object.defineProperty(Array.prototype,"first",{get:function(){return this[0]},
enumerable:!1})})();(function(){L7.rand=function(a,b,c){_.isUndefined(c)&&(c=!1);var d=_.isNumber(b)?a:0,a=_.isNumber(b)?b:a,b=Math.random()*(a-d)+d;return d===(d|0)&&a===(a|0)&&!c?Math.floor(b):b};L7.coin=function(){return 0===L7.rand(0,2)};L7.degreesToRadians=function(a){return(a||0)*Math.PI/180};L7.radiansToDegrees=function(a){return 180*(a||0)/Math.PI}})();
