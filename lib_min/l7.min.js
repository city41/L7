(function(){this.L7=this.L7||{};this.L7.global=this})();
(function(){L7.Actor=function(a){_.extend(this,a);this.position=this.position||L7.p(0,0);this.shape=this.shape||[[5]];this.keyInputs=this.keyInputs||{};this.pieces=this._createPieces();this._listeners={}};L7.Actor.prototype={on:function(a,b,d){this._listeners[a]||(this._listeners[a]=[]);this._listeners[a].push({handler:b,scope:d})},fireEvent:function(a,b){var d=this._listeners[a];if(_.isArray(d)){var e=_.toArray(arguments);e.shift();_.each(d,function(a){a.handler.apply(a.scope,e)})}},_getAnchorOffset:function(){var a,
b;for(b=0;b<this.shape.length;++b)for(a=0;a<this.shape[b].length;++a)if(this.shape[b][a]===L7.Actor.ANCHOR)return L7.p(a,b);throw Error("shape specified but lacks an anchor");},_getColor:function(){return this.color},_createPieces:function(){for(var a=[],b=this._getAnchorOffset(),d=this.position,e=0;e<this.shape.length;++e)for(var f=this.shape[e],h=0;h<f.length;++h)if(this.shape[e][h]){var i=L7.p(h,e).delta(b),i=d.add(i),k=this._getColor(h,e),i=new L7.Piece({position:i,color:k,isAnchor:this.shape[e][h]===
L7.Actor.ANCHOR,owner:this});i.isAnchor&&(this.anchorPiece=i);a.push(i)}return a},_getPiecePositionsAnchoredAt:function(a){var b=a.delta(this.position),d=[];_.each(this.pieces,function(a){d.push(a.position.add(b))});return d},left:function(a){this.goTo(this.position.add(-a,0))},right:function(a){this.goTo(this.position.add(a,0))},up:function(a){this.goTo(this.position.add(0,-a))},down:function(a){this.goTo(this.position.add(0,a))},goBack:function(){this.goTo(this._lastPosition.clone())},goTo:function(a){if(!this.onGoTo||
this.onGoTo(this._getPiecePositionsAnchoredAt(this.position),this._getPiecePositionsAnchoredAt(a),this.board))this._lastPosition=this.position.clone(),this.position=a,this.board&&this.board.moveActor({actor:this,from:this._lastPosition,to:this.position})},update:function(a,b){var d=!1;_(this.keyInputs).each(function(b,f){if(b.repeat&&L7.Keys.down(f)||L7.Keys.downSince(f,this._lastTimestamp||0))d=!0,("undefined"===typeof b.enabled||b.enabled.call(this))&&b.handler.call(this,a)},this);if(!d&&this.onNoKeyDown)this.onNoKeyDown(a);
this._updateTimers(a);this._lastTimestamp=b},_updateTimers:function(a){this.timers&&_.each(this.timers,function(b){if("undefined"===typeof b.enabled||!0===b.enabled||"function"===typeof b.enabled&&b.enabled.call(this))b.elapsed=b.elapsed||0,b.elapsed+=a,b.elapsed>=b.interval&&(b.elapsed-=b.interval,b.handler.call(this))},this)}};Object.defineProperty(L7.Actor,"ANCHOR",{get:function(){return 5},enumerable:!1})})();
(function(){L7.Board=function(a){_.extend(this,a||{});this.size=new L7.Pair(this.width||0,this.height||0);this.borderWidth=this.borderWidth||0;this.tileSize=this.tileSize||0;this._rows=[];this.tiles=[];for(a=0;a<this.height;++a){for(var b=[],d=0;d<this.width;++d){var e=new L7.Tile({x:d,y:a,board:this});e.color=_.clone(this.defaultTileColor);b.push(e);this.tiles.push(e)}this._rows.push(b)}this.actors=[];this.freeActors=[];this.daemons=[];this.viewportWidth=Math.min(this.viewportWidth||this.width,this.width);
this.viewportHeight=Math.min(this.viewportHeight||this.height,this.height);this.viewportAnchorX=this.viewportAnchor&&this.viewportAnchor.x||0;this.viewportAnchorY=this.viewportAnchor&&this.viewportAnchor.y||0;delete this.viewportAnchor;this._hitManager=new L7.HitManager};L7.Board.prototype={destroy:function(){},_clamp:function(a,b,d){return a<b?b:a>=d?d:a},_tileToPixels:function(a){return(this.tileSize+this.borderWidth)*a},scrollCenterOn:function(a){var b=this._tileToPixels(a.x)+this.tileSize/2,a=
this._tileToPixels(a.y)+this.tileSize/2;this.viewport.centerOn(b,a)},scrollY:function(a){this.viewport&&this.viewport.scrollY(this._tileToPixels(a))},scrollX:function(a){this.viewport&&this.viewport.scrollX(this._tileToPixels(a))},scrollXY:function(a,b){this.scrollX(a);this.scrollY(b)},column:function(a){0>a&&(a=this.width+a);for(var b=[],d=0;d<this.height;++d)b.push(this.tileAt(L7.p(a,d)));return b},row:function(a){var b=[];_.each(arguments,function(a){0>a&&(a=this.height+a);for(var e=0;e<this.width;++e)b.push(this.tileAt(L7.p(e,
a)))},this);return b},rect:function(a,b,d,e){for(var f=[],h=b;h<b+e;++h)for(var i=a;i<a+d;++i)f.push(this.tileAt(i,h));return f},query:function(a){var b=[];this.tiles.forEach(function(d){a(d)&&b.push(d)});return b},tileAt:function(a,b){var d=_.isObject(a)?a.x:a,e=_.isNumber(b)?b:a.y;return 0>e||e>=this.height||0>d||d>=this.width?null:this.tiles[e*this.width+d]},tileAtPixels:function(a,b){var d=_.isObject(a)?a.x:a,e=_.isNumber(b)?b:a.y;return this.tileAt(Math.floor(d/(this.tileSize+this.borderWidth)),
Math.floor(e/(this.tileSize+this.borderWidth)))},pixelsForTile:function(a){return L7.p(this._tileToPixels(a.x),this._tileToPixels(a.y))},tileTopInPixels:function(a){return this._tileToPixels(a.y)},tileBottomInPixels:function(a){return this.tileTopInPixels(a)+this.tileSize},each:function(a,b){this.tiles.forEach(a,b)},_addPieces:function(a){a.forEach(function(a){var d=this.tileAt(a.position);d&&d.add(a)},this)},_removePieces:function(a){a.forEach(function(a){var d=this.tileAt(a.position);d&&d.remove(a)},
this)},promote:function(a){a.pieces&&(this._removePieces(a.pieces),this._addPieces(a.pieces))},addActor:function(a){a.pieces&&this._addPieces(a.pieces);this.actors.push(a);a.board=this},addFreeActor:function(a){this.freeActors.push(a);a.board=this},removeFreeActor:function(a){this.freeActors.remove(a);delete a.board},removeActor:function(a){a.pieces&&this._removePieces(a.pieces);this.actors.remove(a);delete a.board},addDaemon:function(a){this.daemons.push(a)},removeDaemon:function(a){this.daemons.remove(a)},
isOutOfBounds:function(a){for(var b=0,d=a.pieces.length;b<d;++b){var e=a.pieces[b].position;if(0>e.x||0>e.y||e.x>=this.width||e.y>=this.height)return!0}return!1},_movePiece:function(a,b){var d=a.position,e=a.position.add(b);(d=this.tileAt(d))&&d.remove(a);(d=this.tileAt(e))&&d.add(a);a.position=e},movePiece:function(a){this._movePiece(a.piece,a.delta||a.to.delta(a.from))},moveActor:function(a){a.actor.pieces.forEach(function(b){this._movePiece(b,a.delta||a.to.delta(a.from))},this);a.actor.onOutOfBounds&&
this.isOutOfBounds(a.actor)&&a.actor.onOutOfBounds.call(a.actor)},update:function(a,b){this.actors.forEach(function(d){d.update(a,b)});this.freeActors.forEach(function(d){d.update(a,b)});this.daemons.forEach(function(d){d.update(a,b,this)},this);this._hitManager.detectHits(this.tiles)},render:function(a,b,d,e){var f=this.borderWidth,a=this.tileSize,h=(0>e?Math.ceil:Math.floor)(e/(a+f)),i=-e%(a+f),k,u=Math.min(this._rows.length,Math.ceil((e+b.canvas.height)/(a+f))),n=(0>d?Math.ceil:Math.floor)(d/(a+
f)),l=-d%(a+f),q,z=Math.min(this._rows[0].length,Math.ceil((d+b.canvas.width)/(a+f))),r,m,v,s=[];for(k=h;k<u;++k)if(0<=k){v=this._rows[k];for(q=n;q<z;++q)0<=q&&(r=v[q],m=r.getColor(),o=r.getScale(),_.isNumber(o)||(o=1),1!==o&&(s.push(r),m=r.getColor(!0),o=1),this.borderFill&&(b.fillStyle=this.borderFill,b.fillRect((q-n)*(a+f)+l,(k-h)*(a+f)+i,a+2*f,a+2*f)),b.fillStyle=m,m=Math.round(a*o),o=a/2-m/2,b.fillRect((q-n)*(a+f)+f+o+l,(k-h)*(a+f)+f+o+i,m,m))}s.sort(function(a,b){return a.scale-b.scale});for(k=
0;k<s.length;++k){r=s[k];var o=r.getScale();if(m=r.getColor())b.fillStyle=m,m=Math.round(a*o),o=a/2-m/2,b.fillRect((r.x-n)*(a+f)+f+o+l,(r.y-h)*(a+f)+f+o+i,m,m)}for(k=0;k<this.freeActors.length;++k)if(f=this.freeActors[k],m=L7.Color.toCssString(f.color))b.fillStyle=m,b.fillRect(f.position.x-d,f.position.y-e,a,a)}}})();
(function(){L7.HitManager=function(){};L7.HitManager.prototype={detectHits:function(a){a.forEach(function(a){this._detectTileHits(a)},this)},_detectTileHits:function(a){a.each(function(b){_.isObject(b.owner)&&_.isObject(b.owner.hitDetection)&&("undefined"===typeof b.owner.hitDetection.enabled||b.owner.hitDetection.enabled.call(b.owner))&&_.each(b.owner.hitDetection,function(d,e){a.tag===e&&d.call(b.owner,a,a);a.each(function(f){f!==b&&f.owner&&f.owner.team===e&&d.call(b.owner,a,f.owner)},this)},this)},
this)}}})();
(function(){L7.ParallaxBoard=function(a){_.extend(this,a);this.boards=this.boards||[];this.boards.forEach(function(a){if(!_.isNumber(a.parallaxRatio))throw Error("ParallaxBoard: given a board that lacks a parallax ratio");})};L7.ParallaxBoard.prototype={update:function(){var a=_.toArray(arguments);this.boards.forEach(function(b){b.update.apply(b,a)})},render:function(a,b,d,e,f){this.boards.forEach(function(h){h.render(a,b,d*h.parallaxRatio,e*h.parallaxRatio,f)})}};Object.defineProperty(L7.ParallaxBoard.prototype,"viewport",
{get:function(){return this.viewport},set:function(a){this.boards.forEach(function(b){b.viewport=a})},enumerable:!0})})();(function(){L7.Piece=function(a){_.extend(this,a||{})};L7.Piece.prototype={render:function(){this.sprite&&(this.sprite.overlay=this._overlay,this.sprite.render.apply(this.sprite,arguments))}};Object.defineProperty(L7.Piece.prototype,"overlay",{get:function(){return this._overlay},set:function(a){this._overlay=a},enumerable:!0})})();
(function(){L7.Tile=function(a){a=a||{};if(!_.isNumber(a.x))throw Error("Tile: x is required");if(!_.isNumber(a.y))throw Error("Tile: y is required");this.x=a.x;this.y=a.y;this.color=a.color;this.scale=a.scale;this.board=a.board;this.inhabitants=_.clone(a.inhabitants||[]);this.position=L7.p(this.x,this.y)};L7.Tile.prototype={at:function(a){return this.inhabitants[a]},each:function(a,b){this.inhabitants.forEach(a,b)},add:function(a){this.inhabitants.push(a)},remove:function(a){this.inhabitants.remove(a)},
has:function(a){return this.tag===a?!0:this.inhabitants.some(function(b){return b.team===a||b.owner&&b.owner.team===a})},hasOther:function(a,b){return this.tag===a?!0:this.inhabitants.some(function(d){return d.team===a||d.owner&&d.owner.team===a&&d.owner!==b})},getColor:function(a){var b=[];this.color&&b.push(this.color);!a&&0<this.inhabitants.length&&this.inhabitants.last.color&&b.push(this.inhabitants.last.color);this.overlayColor&&b.push(this.overlayColor);if(0<b.length)return a=L7.Color.composite.apply(L7.Color,
b),L7.Color.toCssString(a)},getColorOld:function(){var a;if(0===this.inhabitants.length||!this.inhabitants[this.inhabitants.length-1].color)a=this.color;else if(a=this.inhabitants[this.inhabitants.length-1],L7.Color.isOpaque(a.color)||!this.color)a=a.color;else{var b=this.color.slice(0);a=L7.Color.composite(b,a.color)}this.overlayColor&&(a=!a||L7.Color.isOpaque(this.overlayColor)?this.overlayColor:L7.Color.composite(a.slice(0),this.overlayColor));if(a)return L7.Color.toCssString(a)},getScale:function(){return 0===
this.inhabitants.length||!this.inhabitants.last.color?this.scale:this.inhabitants.last.scale},up:function(){return this.board&&this.board.tileAt(this.position.up())},down:function(){return this.board&&this.board.tileAt(this.position.down())},left:function(){return this.board&&this.board.tileAt(this.position.left())},right:function(){return this.board&&this.board.tileAt(this.position.right())}};Object.defineProperty(L7.Tile.prototype,"count",{get:function(){return this.inhabitants.length},enumerable:!0})})();
(function(){function a(a){var a=a.substring(1),b=a.substring(0,2),f=a.substring(2,4),a=a.substring(4,6);return result=[parseInt(b,16),parseInt(f,16),parseInt(a,16),1]}L7.Color={toCssString:function(a){return 3===a.length?"rgb("+a[0]+","+a[1]+","+a[2]+")":"rgba("+a[0]+","+a[1]+","+a[2]+","+a[3]+")"},isBuiltInString:function(a){return"string"!==typeof a?!1:b.hasOwnProperty(a.toLowerCase())},isHexString:function(a){if("string"!==typeof a||"#"!==a[0]||7!==a.length)return!1;for(var a=a.toUpperCase(),b=
1,f=a.length;b<f;++b){var h=a[b];if("0">h||"F"<h)return!1}return!0},isOpaque:function(a){return this.isHexString(a)||this.isBuiltInString(a)?!0:(a=this.toArray(a))&&1===a[3]},isRgbString:function(a){return"string"!==typeof a||10>a.length||0!==a.indexOf("rgb")||")"!==a[a.length-1]||"("!==a[3]&&"("!==a[4]?!1:!0},toArray:function(d){if(_.isArray(d)&&4===d.length)return d;if(this.isHexString(d))return a(d);if(this.isBuiltInString(d))return a(b[d]);if(this.isRgbString(d)){for(var e=d.indexOf("("),f=[],
d=d.substring(e+1).split(","),e=0,h=d.length;e<h;++e)f.push(parseFloat(d[e]));3===f.length&&f.push(1);return f}},fromArrayToHex:function(a,b){for(var f="#",h=b&&b.includeAlpha&&4===a.length?4:3,i=0;i<h;++i){var k=a[i].toString(16);2>k.length&&(k="0"+k);f+=k}return f.toUpperCase()},composite:function(a){for(var b=this.toArray(arguments[0]).slice(0),f=1;f<arguments.length;++f){var h=b,i=this.toArray(arguments[f]),k=i[3],u=h[3],n=1-k,l=void 0,q=void 0;for(l=0,q=h.length-1;l<q;++l)h[l]=Math.round(i[l]*
k+h[l]*u*n)}b[3]=1;return b}};var b={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",
darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",
gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",
lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370D8",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",
mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#D87093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",
seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"}})();
(function(){L7.LevelLoader=function(a){_.extend(this,a);this.width=a.image.width;this.height=a.image.height};L7.LevelLoader.prototype={load:function(){for(var a=_.extend(this.boardConfig,{width:this.width,height:this.height}),b=new L7.Board(a),d={},a=this._getData(),e=0;e<a.length;e+=4){var f=this._extractColor(a,e),h=this.legend[f];if(h){var i=this._getPosition(e);if(h.hasOwnProperty("constructor")){var k=_.extend({},h.config||{},{position:i});_.isArray(h.constructor)||(h.constructor=[h.constructor]);
h.constructor.forEach(function(a){a=new a(k);d[f]=d[f]||[];d[f].push(a);b.addActor(a)})}h.tag&&(b.tileAt(i).tag=h.tag);h.color&&(b.tileAt(i).color=h.color)}}return{board:b,actors:d}},_getData:function(){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;a=a.getContext("2d");a.drawImage(this.image,0,0);return a.getImageData(0,0,this.width,this.height).data},_extractColor:function(a,b){for(var d=[],e=b;e<b+3;++e)d.push(a[e]);return L7.Color.fromArrayToHex(d)},_getPosition:function(a){a=
Math.floor(a/4);return L7.p(a%this.width,Math.floor(a/this.width))}}})();
(function(){var a=1E3*(1/60);window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)};L7.Game=function(a){a=a instanceof L7.Board?{width:a.width*(a.tileSize+a.borderWidth)+a.borderWidth,height:a.height*(a.tileSize+a.borderWidth)+a.borderWidth,board:a}:a;_.extend(this,a);_.bindAll(this,"_doFrame");this.viewport=new L7.Viewport(this);
this.board&&(this.board.viewport=this.viewport);this.container=this.container||document.body;this.canvas=this._createCanvas();this.delays=[]};L7.Game.prototype={_createCanvas:function(){var a=document.createElement("canvas");a.width=this.viewport.width;a.height=this.viewport.height;a.style.imageRendering="-webkit-optimize-contrast";this.container.appendChild(a);return a},go:function(){this._lastTimestamp=Date.now();this._doFrame(this._lastTimestamp)},after:function(a,d){this.delays.add({remaining:a,
handler:d})},replaceBoard:function(a){this.board&&this.board.destroy&&this.board.destroy();this.board=a;this.board.viewport=this.viewport;this.viewport.reset()},_updateDelays:function(a){var d=[];this.delays.forEach(function(e){e.remaining-=a;0>=e.remaining&&(e.handler.call(e.scope,this),d.push(e))},this);d.forEach(function(a){this.delays.remove(a)},this)},_doFrame:function(b){var d=b-this._lastTimestamp;this._lastTimestamp=b;for(var e=d;0<e;){var f=Math.min(a,e);this._updateDelays(f);this.board.update(f,
b);e-=f}e=this.canvas.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height);this.board.render(d,e,this.viewport.anchorX,this.viewport.anchorY,b);requestAnimationFrame(this._doFrame)}}})();
(function(){L7.Keys={arrows:{37:"left",38:"up",39:"right",40:"down"},init:function(){this._hook=window;this._keyDownListener=_.bind(this._onKeyDown,this);this._hook.addEventListener("keydown",this._keyDownListener,!1);this._keyUpListener=_.bind(this._onKeyUp,this);this._hook.addEventListener("keyup",this._keyUpListener,!1);this._downKeys={}},_getCharacter:function(a){return this.arrows[a.toString()]||String.fromCharCode(a).toLowerCase()},_onKeyDown:function(a){a=this._getCharacter(a.keyCode);this._downKeys[a]||
(this._downKeys[a]=Date.now())},_onKeyUp:function(a){delete this._downKeys[this._getCharacter(a.keyCode)]},down:function(a){return void 0!==this._downKeys[a]},downSince:function(a,b){return this.down(a)&&this._downKeys[a]>b}}})();
(function(){L7.Viewport=function(a){a=a||{};_.extend(this,a);_.isUndefined(this.preventOverscroll)&&(this.preventOverscroll=!1);this.anchorX=a.initialAnchor&&a.initialAnchor.x||0;this.anchorY=a.initialAnchor&&a.initialAnchor.y||0;this.width=this.width||100;this.height=this.height||100};L7.Viewport.prototype={scrollY:function(a){this.anchorY+=a},scrollX:function(a){this.anchorX+=a},centerOn:function(a,b){var d=a.y||b;this.anchorX=Math.floor((a.x||a)-this.width/2);this.anchorY=Math.floor(d-this.height/
2)},reset:function(){this.anchorY=this.anchorX=0}}})();
(function(){L7.Pair=function(a,b){this._a=a||0;this._b=b||0};L7.Pair.prototype={clone:function(){return L7.p(this.x,this.y)},equals:function(a){return a?a===this||a._a===this._a&&a._b==this._b||a.x===this._a&&a.y==this._b||a.width==this._a&&a.height==this._b:!1},up:function(){return L7.p(this.x,this.y-1)},left:function(){return L7.p(this.x-1,this.y)},right:function(){return L7.p(this.x+1,this.y)},down:function(){return L7.p(this.x,this.y+1)},add:function(a,b){return L7.p(this.x+("number"===typeof a.x?
a.x:a||0),this.y+("number"===typeof a.y?a.y:b||0))},subtract:function(a,b){x="number"===typeof a.x?a.x:a||0;y="number"===typeof a.y?a.y:b||0;return L7.p(this.x-x,this.y-y)},negate:function(){return L7.p(-this.x,-this.y)},multiply:function(a){return L7.p(this.x*a,this.y*a)},dot:function(a){return this.x*a.x+this.y*a.y},distanceFrom:function(a){a=this.delta(a);return Math.sqrt(a.dot(a))},toString:function(){return"["+this._a+","+this._b+"]"}};L7.Pair.prototype.delta=L7.Pair.prototype.subtract;Object.defineProperty(L7.Pair.prototype,
"width",{get:function(){return this._a}});Object.defineProperty(L7.Pair.prototype,"height",{get:function(){return this._b}});Object.defineProperty(L7.Pair.prototype,"x",{get:function(){return this._a}});Object.defineProperty(L7.Pair.prototype,"y",{get:function(){return this._b}});L7.s=function(a,b){return new L7.Pair(a,b)};L7.p=L7.s;L7.sr=function(a,b){return new L7.Pair(Math.round(a),Math.round(b))};L7.pr=L7.sr})();
(function(){function a(g,j,b){if(g===j)return 0!==g||1/g==1/j;if(null==g||null==j)return g===j;g._chain&&(g=g._wrapped);j._chain&&(j=j._wrapped);if(g.isEqual&&c.isFunction(g.isEqual))return g.isEqual(j);if(j.isEqual&&c.isFunction(j.isEqual))return j.isEqual(g);var B=n.call(g);if(B!=n.call(j))return!1;switch(B){case "[object String]":return g==""+j;case "[object Number]":return g!=+g?j!=+j:0==g?1/g==1/j:g==+j;case "[object Date]":case "[object Boolean]":return+g==+j;case "[object RegExp]":return g.source==
j.source&&g.global==j.global&&g.multiline==j.multiline&&g.ignoreCase==j.ignoreCase}if("object"!=typeof g||"object"!=typeof j)return!1;for(var d=b.length;d--;)if(b[d]==g)return!0;b.push(g);var d=0,e=!0;if("[object Array]"==B){if(d=g.length,e=d==j.length)for(;d--&&(e=d in g==d in j&&a(g[d],j[d],b)););}else{if("constructor"in g!="constructor"in j||g.constructor!=j.constructor)return!1;for(var f in g)if(l.call(g,f)&&(d++,!(e=l.call(j,f)&&a(g[f],j[f],b))))break;if(e){for(f in j)if(l.call(j,f)&&!d--)break;
e=!d}}b.pop();return e}var b=this,d=b._,e={},f=Array.prototype,h=Object.prototype,i=f.slice,k=f.concat,u=f.unshift,n=h.toString,l=h.hasOwnProperty,q=f.forEach,z=f.map,r=f.reduce,m=f.reduceRight,v=f.filter,s=f.every,o=f.some,A=f.indexOf,E=f.lastIndexOf,h=Array.isArray,H=Object.keys,C=Function.prototype.bind,c=function(a){return new t(a)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports._=c):"function"===typeof define&&define.amd?define("underscore",
function(){return c}):b._=c;c.VERSION="1.2.3";var p=c.each=c.forEach=function(a,j,b){if(null!=a)if(q&&a.forEach===q)a.forEach(j,b);else if(a.length===+a.length)for(var c=0,d=a.length;c<d&&!(c in a&&j.call(b,a[c],c,a)===e);c++);else for(c in a)if(l.call(a,c)&&j.call(b,a[c],c,a)===e)break};c.map=function(a,j,b){var c=[];if(null==a)return c;if(z&&a.map===z)return a.map(j,b);p(a,function(a,g,d){c[c.length]=j.call(b,a,g,d)});return c};c.reduce=c.foldl=c.inject=function(a,j,b,d){var e=2<arguments.length;
null==a&&(a=[]);if(r&&a.reduce===r)return d&&(j=c.bind(j,d)),e?a.reduce(j,b):a.reduce(j);p(a,function(a,g,c){e?b=j.call(d,b,a,g,c):(b=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return b};c.reduceRight=c.foldr=function(a,b,w,d){var e=2<arguments.length;null==a&&(a=[]);if(m&&a.reduceRight===m)return d&&(b=c.bind(b,d)),e?a.reduceRight(b,w):a.reduceRight(b);var f=c.toArray(a).reverse();d&&!e&&(b=c.bind(b,d));return e?c.reduce(f,b,w,d):c.reduce(f,b)};c.find=c.detect=
function(a,b,c){var d;F(a,function(a,g,e){if(b.call(c,a,g,e))return d=a,!0});return d};c.filter=c.select=function(a,b,c){var d=[];if(null==a)return d;if(v&&a.filter===v)return a.filter(b,c);p(a,function(a,g,e){b.call(c,a,g,e)&&(d[d.length]=a)});return d};c.reject=function(a,b,c){var d=[];if(null==a)return d;p(a,function(a,g,e){b.call(c,a,g,e)||(d[d.length]=a)});return d};c.every=c.all=function(a,b,c){var d=!0;if(null==a)return d;if(s&&a.every===s)return a.every(b,c);p(a,function(a,g,f){if(!(d=d&&
b.call(c,a,g,f)))return e});return d};var F=c.some=c.any=function(a,b,d){b||(b=c.identity);var f=!1;if(null==a)return f;if(o&&a.some===o)return a.some(b,d);p(a,function(a,g,c){if(f||(f=b.call(d,a,g,c)))return e});return!!f};c.include=c.contains=function(a,b){return null==a?!1:A&&a.indexOf===A?-1!=a.indexOf(b):F(a,function(a){return a===b})};c.invoke=function(a,b){var d=i.call(arguments,2);return c.map(a,function(a){return(b.call?b||a:a[b]).apply(a,d)})};c.pluck=function(a,b){return c.map(a,function(a){return a[b]})};
c.max=function(a,b,d){if(!b&&c.isArray(a))return Math.max.apply(Math,a);if(!b&&c.isEmpty(a))return-Infinity;var e={computed:-Infinity};p(a,function(a,g,c){g=b?b.call(d,a,g,c):a;g>=e.computed&&(e={value:a,computed:g})});return e.value};c.min=function(a,b,d){if(!b&&c.isArray(a))return Math.min.apply(Math,a);if(!b&&c.isEmpty(a))return Infinity;var e={computed:Infinity};p(a,function(a,g,c){g=b?b.call(d,a,g,c):a;g<e.computed&&(e={value:a,computed:g})});return e.value};c.shuffle=function(a){var b=[],c;
p(a,function(a,g){0==g?b[0]=a:(c=Math.floor(Math.random()*(g+1)),b[g]=b[c],b[c]=a)});return b};c.sortBy=function(a,b,d){return c.pluck(c.map(a,function(a,g,c){return{value:a,criteria:b.call(d,a,g,c)}}).sort(function(a,g){var b=a.criteria,c=g.criteria;return b<c?-1:b>c?1:0}),"value")};c.groupBy=function(a,b){var d={},e=c.isFunction(b)?b:function(a){return a[b]};p(a,function(a,b){var g=e(a,b);(d[g]||(d[g]=[])).push(a)});return d};c.sortedIndex=function(a,b,d){d||(d=c.identity);for(var e=0,f=a.length;e<
f;){var h=e+f>>1;d(a[h])<d(b)?e=h+1:f=h}return e};c.toArray=function(a){return!a?[]:a.toArray?a.toArray():c.isArray(a)?i.call(a):c.isArguments(a)?i.call(a):c.values(a)};c.size=function(a){return c.toArray(a).length};c.first=c.head=function(a,b,c){return null!=b&&!c?i.call(a,0,b):a[0]};c.initial=function(a,b,c){return i.call(a,0,a.length-(null==b||c?1:b))};c.last=function(a,b,c){return null!=b&&!c?i.call(a,Math.max(a.length-b,0)):a[a.length-1]};c.rest=c.tail=function(a,b,c){return i.call(a,null==b||
c?1:b)};c.compact=function(a){return c.filter(a,function(a){return!!a})};c.flatten=function(a,b){return c.reduce(a,function(a,g){if(c.isArray(g))return a.concat(b?g:c.flatten(g));a[a.length]=g;return a},[])};c.without=function(a){return c.difference(a,i.call(arguments,1))};c.uniq=c.unique=function(a,b,d){var d=d?c.map(a,d):a,e=[];c.reduce(d,function(d,f,w){if(0==w||(!0===b?c.last(d)!=f:!c.include(d,f)))d[d.length]=f,e[e.length]=a[w];return d},[]);return e};c.union=function(){return c.uniq(c.flatten(arguments,
!0))};c.intersection=c.intersect=function(a){var b=i.call(arguments,1);return c.filter(c.uniq(a),function(a){return c.every(b,function(b){return 0<=c.indexOf(b,a)})})};c.difference=function(a){var b=c.flatten(i.call(arguments,1));return c.filter(a,function(a){return!c.include(b,a)})};c.zip=function(){for(var a=i.call(arguments),b=c.max(c.pluck(a,"length")),d=Array(b),e=0;e<b;e++)d[e]=c.pluck(a,""+e);return d};c.indexOf=function(a,b,d){if(null==a)return-1;var e;if(d)return d=c.sortedIndex(a,b),a[d]===
b?d:-1;if(A&&a.indexOf===A)return a.indexOf(b);for(d=0,e=a.length;d<e;d++)if(d in a&&a[d]===b)return d;return-1};c.lastIndexOf=function(a,b){if(null==a)return-1;if(E&&a.lastIndexOf===E)return a.lastIndexOf(b);for(var c=a.length;c--;)if(c in a&&a[c]===b)return c;return-1};c.range=function(a,b,c){1>=arguments.length&&(b=a||0,a=0);for(var c=arguments[2]||1,d=Math.max(Math.ceil((b-a)/c),0),e=0,f=Array(d);e<d;)f[e++]=a,a+=c;return f};var G=function(){};c.bind=function(a,b){var d,e;if(a.bind===C&&C)return C.apply(a,
i.call(arguments,1));if(!c.isFunction(a))throw new TypeError;e=i.call(arguments,2);return d=function(){if(!(this instanceof d))return a.apply(b,e.concat(i.call(arguments)));G.prototype=a.prototype;var c=new G,f=a.apply(c,e.concat(i.call(arguments)));return Object(f)===f?f:c}};c.bindAll=function(a){var b=i.call(arguments,1);0==b.length&&(b=c.functions(a));p(b,function(b){a[b]=c.bind(a[b],a)});return a};c.memoize=function(a,b){var d={};b||(b=c.identity);return function(){var c=b.apply(this,arguments);
return l.call(d,c)?d[c]:d[c]=a.apply(this,arguments)}};c.delay=function(a,b){var c=i.call(arguments,2);return setTimeout(function(){return a.apply(a,c)},b)};c.defer=function(a){return c.delay.apply(c,[a,1].concat(i.call(arguments,1)))};c.throttle=function(a,b){var d,e,f,h,i,k=c.debounce(function(){i=h=!1},b);return function(){d=this;e=arguments;f||(f=setTimeout(function(){f=null;i&&a.apply(d,e);k()},b));h?i=!0:a.apply(d,e);k();h=!0}};c.debounce=function(a,b){var c;return function(){var d=this,e=arguments;
clearTimeout(c);c=setTimeout(function(){c=null;a.apply(d,e)},b)}};c.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}};c.wrap=function(a,b){return function(){var c=k.apply([a],arguments);return b.apply(this,c)}};c.compose=function(){var a=arguments;return function(){for(var b=arguments,c=a.length-1;0<=c;c--)b=[a[c].apply(this,b)];return b[0]}};c.after=function(a,b){return 0>=a?b():function(){if(1>--a)return b.apply(this,arguments)}};c.keys=H||function(a){if(a!==
Object(a))throw new TypeError("Invalid object");var b=[],c;for(c in a)l.call(a,c)&&(b[b.length]=c);return b};c.values=function(a){return c.map(a,c.identity)};c.functions=c.methods=function(a){var b=[],d;for(d in a)c.isFunction(a[d])&&b.push(d);return b.sort()};c.extend=function(a){p(i.call(arguments,1),function(b){for(var c in b)void 0!==b[c]&&(a[c]=b[c])});return a};c.defaults=function(a){p(i.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])});return a};c.clone=function(a){return!c.isObject(a)?
a:c.isArray(a)?a.slice():c.extend({},a)};c.tap=function(a,b){b(a);return a};c.isEqual=function(b,c){return a(b,c,[])};c.isEmpty=function(a){if(c.isArray(a)||c.isString(a))return 0===a.length;for(var b in a)if(l.call(a,b))return!1;return!0};c.isElement=function(a){return!!(a&&1==a.nodeType)};c.isArray=h||function(a){return"[object Array]"==n.call(a)};c.isObject=function(a){return a===Object(a)};c.isArguments=function(a){return"[object Arguments]"==n.call(a)};c.isArguments(arguments)||(c.isArguments=
function(a){return!(!a||!l.call(a,"callee"))});c.isFunction=function(a){return"[object Function]"==n.call(a)};c.isString=function(a){return"[object String]"==n.call(a)};c.isNumber=function(a){return"[object Number]"==n.call(a)};c.isNaN=function(a){return a!==a};c.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==n.call(a)};c.isDate=function(a){return"[object Date]"==n.call(a)};c.isRegExp=function(a){return"[object RegExp]"==n.call(a)};c.isNull=function(a){return null===a};c.isUndefined=
function(a){return void 0===a};c.noConflict=function(){b._=d;return this};c.identity=function(a){return a};c.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)};c.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};c.mixin=function(a){p(c.functions(a),function(b){I(b,c[b]=a[b])})};var J=0;c.uniqueId=function(a){var b=J++;return a?a+b:b};c.templateSettings={evaluate:/<%([\s\S]+?)%>/g,
interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};c.template=function(a,b){var d=c.templateSettings,d="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(d.escape,function(a,b){return"',_.escape("+b.replace(/\\'/g,"'")+"),'"}).replace(d.interpolate,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(d.evaluate||null,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,
"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",e=new Function("obj","_",d);return b?e(b,c):function(a){return e.call(this,a,c)}};var t=function(a){this._wrapped=a};c.prototype=t.prototype;var D=function(a,b){return b?c(a).chain():a},I=function(a,b){t.prototype[a]=function(){var a=i.call(arguments);u.call(a,this._wrapped);return D(b.apply(c,a),this._chain)}};c.mixin(c);p("pop,push,reverse,shift,sort,splice,unshift".split(","),function(a){var b=f[a];t.prototype[a]=function(){b.apply(this._wrapped,
arguments);return D(this._wrapped,this._chain)}});p(["concat","join","slice"],function(a){var b=f[a];t.prototype[a]=function(){return D(b.apply(this._wrapped,arguments),this._chain)}});t.prototype.chain=function(){this._chain=!0;return this};t.prototype.value=function(){return this._wrapped}}).call(this);
(function(){L7.FadeBase=function(a){_.extend(this,a);this.elapsed=0;this.color&&(this.color=L7.Color.toArray(this.color))};L7.FadeBase.prototype={update:function(a,b){this.elapsed+=a;var d=this.elapsed/this.duration;this.updateColor(this.color,d);if(1<d&&this.onComplete)this.onComplete(this);this.board.update(a,b)},render:function(a,b,d,e,f){this.board.render(a,b,d,e,f);b.save();b.fillStyle=L7.Color.toCssString(this.color);b.fillRect(0,0,b.canvas.width,b.canvas.height);b.restore()}};Object.defineProperty(L7.FadeBase.prototype,
"viewport",{set:function(a){this._viewport=a;this.board&&(this.board.viewport=a)},get:function(){return this._viewport},enumerable:!0})})();(function(){L7.FadeIn=function(a){a.color=a.from;L7.FadeBase.call(this,a)};L7.FadeIn.prototype=new L7.FadeBase;L7.FadeIn.prototype.updateColor=function(a,b){a[3]=1-b}})();(function(){L7.FadeOut=function(a){a.color=a.to;L7.FadeBase.call(this,a)};L7.FadeOut.prototype=new L7.FadeBase;L7.FadeOut.prototype.updateColor=function(a,b){a[3]=b}})();
(function(){L7.FadeOutIn=function(a){_.extend(this,a);_.bindAll(this,"_onFadeOutComplete","_onFadeInComplete");this.delegate=new L7.FadeOut({board:this.fromBoard,to:this.color,duration:this.duration/2,onComplete:this._onFadeOutComplete})};L7.FadeOutIn.prototype={_onFadeOutComplete:function(){this.delegate=new L7.FadeIn({board:this.toBoard,from:this.color,duration:this.duration/2,onComplete:this._onFadeInComplete});this.delegate.viewport=this.viewport},_onFadeInComplete:function(){if(this.onComplete)this.onComplete();
else this.game&&this.game.replaceBoard(this.toBoard)},update:function(){this.delegate.update.apply(this.delegate,arguments)},render:function(){this.delegate.render.apply(this.delegate,arguments)}};Object.defineProperty(L7.FadeOutIn.prototype,"viewport",{set:function(a){this._viewport=a;this.delegate&&(this.delegate.viewport=a)},get:function(){return this._viewport},enumerable:!0})})();
(function(){"undefined"===typeof Array.prototype.add&&(Array.prototype.add=function(a){this.push(a);return this});"undefined"===typeof Array.prototype.remove&&(Array.prototype.remove=function(a){a=this.indexOf(a);0<=a&&this.splice(a,1);return this});"undefined"===typeof Array.prototype.last&&Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]},enumerable:!1});"undefined"===typeof Array.prototype.first&&Object.defineProperty(Array.prototype,"first",{get:function(){return this[0]},
enumerable:!1})})();(function(){L7.rand=function(a,b){var d=_.isNumber(b)?a:0,e=_.isNumber(b)?b:a,f=Math.random()*(e-d)+d;return d===(d|0)&&e===(e|0)?Math.floor(f):f}})();
